---
phase: 07-admin-meeting-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/actions/meeting.ts
  - src/app/admin/meetings/page.tsx
  - src/app/admin/meetings/new/page.tsx
  - src/app/admin/meetings/[id]/page.tsx
  - src/components/admin/MeetingCard.tsx
  - src/app/admin/page.tsx
autonomous: true
requirements: [MEET-01]

must_haves:
  truths:
    - "Admin can navigate to Moter from the admin hub"
    - "Admin can create a new meeting with date, time, and venue"
    - "After creation, admin is redirected to the meeting detail page"
    - "If an upcoming meeting already exists, creation is blocked with a message"
    - "Meetings overview shows the upcoming meeting prominently and previous meetings below"
  artifacts:
    - path: "src/lib/actions/meeting.ts"
      provides: "Meeting CRUD server actions"
      exports: ["createMeeting"]
    - path: "src/app/admin/meetings/page.tsx"
      provides: "Meetings overview page"
    - path: "src/app/admin/meetings/new/page.tsx"
      provides: "Meeting creation form"
    - path: "src/app/admin/meetings/[id]/page.tsx"
      provides: "Meeting detail page shell (tabs added in Plan 02)"
    - path: "src/components/admin/MeetingCard.tsx"
      provides: "Meeting card component for overview list"
    - path: "src/app/admin/page.tsx"
      provides: "Updated admin hub with Moter replacing Grupper"
  key_links:
    - from: "src/app/admin/meetings/new/page.tsx"
      to: "src/lib/actions/meeting.ts"
      via: "useActionState + createMeeting server action"
      pattern: "useActionState.*createMeeting"
    - from: "src/app/admin/meetings/page.tsx"
      to: "meetings table"
      via: "Supabase query in server component"
      pattern: "from.*meetings.*select"
    - from: "src/app/admin/page.tsx"
      to: "/admin/meetings"
      via: "Link component replacing /admin/groups"
      pattern: "href.*admin/meetings"
---

<objective>
Create meeting CRUD foundation: server actions for meeting creation, meetings overview page, meeting creation form, meeting detail page shell, and restructured admin hub.

Purpose: Establish the meeting-centric admin architecture that all subsequent plans build on. Admin can create meetings and navigate the new meeting hub.
Output: Meeting server actions, three new route pages, MeetingCard component, updated admin hub.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-admin-meeting-management/07-RESEARCH.md
@.planning/phases/07-admin-meeting-management/07-CONTEXT.md

@src/lib/actions/admin.ts
@src/app/admin/page.tsx
@src/app/admin/layout.tsx
@src/components/ui/Button.tsx
@src/components/ui/Input.tsx
@src/components/ui/Label.tsx
@src/components/ui/Card.tsx
@src/components/ui/Badge.tsx
@src/components/ui/EmptyState.tsx
@supabase/migrations/020_meetings_migration.sql

<interfaces>
<!-- Key types and contracts the executor needs. Extracted from codebase. -->

From src/lib/actions/admin.ts (pattern to follow):
```typescript
async function verifyAdmin(): Promise<{ userId: string } | { error: string }>
// Every admin action: verify caller, use createAdminClient(), revalidatePath()
```

From src/lib/supabase/server.ts:
```typescript
export async function createClient(): Promise<SupabaseClient>
```

From src/lib/supabase/admin.ts:
```typescript
export function createAdminClient(): SupabaseClient
```

From supabase/migrations/020_meetings_migration.sql (meetings table schema):
```sql
CREATE TABLE meetings (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  title TEXT NOT NULL,
  status TEXT NOT NULL DEFAULT 'upcoming'
    CHECK (status IN ('upcoming', 'active', 'completed')),
  date DATE,
  time TIME,
  venue TEXT,
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now()
);
-- Partial unique index: only one upcoming meeting
CREATE UNIQUE INDEX idx_one_upcoming_meeting ON meetings ((true)) WHERE status = 'upcoming';
```

From src/components/ui/Dialog.tsx:
```typescript
interface DialogProps {
  open: boolean; onClose: () => void; onConfirm: () => void;
  title: string; description: string;
  confirmLabel?: string; confirmVariant?: 'primary' | 'danger'; loading?: boolean;
}
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Meeting server actions and admin hub restructure</name>
  <files>src/lib/actions/meeting.ts, src/app/admin/page.tsx</files>
  <action>
**Create `src/lib/actions/meeting.ts`** with the following server actions:

1. **`createMeeting(prevState, formData)`** — useActionState-compatible signature `(prevState: { error?: string } | null, formData: FormData) => Promise<{ error?: string; id?: string }>`:
   - Call `verifyAdmin()` (import from a shared helper or duplicate the pattern from admin.ts — use the same pattern as admin.ts: import createClient from server, createAdminClient from admin)
   - Extract `date`, `time`, `venue` from formData. Validate all three are present — return `{ error: 'Alle felt er påkrevd' }` if missing
   - Check for existing upcoming meeting: `admin.from('meetings').select('id').eq('status', 'upcoming').maybeSingle()` — if exists, return `{ error: 'Det finnes allerede et kommende møte' }`
   - Auto-generate title: query count of all meetings, set title to `Fellesmøte #${count + 1}`
   - Insert meeting: `admin.from('meetings').insert({ title, date, time, venue, status: 'upcoming' }).select('id').single()`
   - `revalidatePath('/admin/meetings')`
   - Return `{ id: data.id }`

2. **`deleteMeeting(meetingId: string)`** — for deleting upcoming meetings that haven't been activated:
   - verifyAdmin()
   - Check meeting status is 'upcoming' — refuse if active/completed
   - `admin.from('meetings').delete().eq('id', meetingId)`
   - `revalidatePath('/admin/meetings')`
   - Return `{ error?: string }`

Include the same `verifyAdmin()` helper pattern from admin.ts (duplicate it — it's small and avoids cross-import complexity).

**Modify `src/app/admin/page.tsx`:**
- Replace the "Grupper" card link (href="/admin/groups") with "Møter" (href="/admin/meetings")
- Update the icon to a calendar-like SVG (use Heroicons-style calendar icon)
- Update description to: "Opprett møter, konfigurer stasjoner og grupper"
- Remove the standalone "Ordsky" card and "Eksporter samtaler" card — these are absorbed into meeting detail Resultat tab
- Keep "Brukere" card and "Logg ut" button unchanged
- Add a "Møter" card as the FIRST card (above Brukere), since it's the primary admin action now
  </action>
  <verify>
    <automated>cd /Users/mariusvalle-olsen/Github/TbgRuss28 && npx tsc --noEmit --pretty 2>&1 | head -30</automated>
  </verify>
  <done>
- `src/lib/actions/meeting.ts` exists with createMeeting and deleteMeeting server actions
- Admin hub shows "Møter" as the first card linking to /admin/meetings
- "Grupper", "Ordsky", and "Eksporter" cards are removed from admin hub (absorbed into meetings)
  </done>
</task>

<task type="auto">
  <name>Task 2: Meetings overview, creation form, and detail page shell</name>
  <files>src/app/admin/meetings/page.tsx, src/app/admin/meetings/new/page.tsx, src/app/admin/meetings/[id]/page.tsx, src/components/admin/MeetingCard.tsx</files>
  <action>
**Create `src/components/admin/MeetingCard.tsx`** — client component:
- Props: `meeting: { id: string; title: string; status: string; date: string | null; time: string | null; venue: string | null; created_at: string }`, `variant: 'upcoming' | 'previous'`
- For `upcoming` variant: larger card with double border (border-2 border-teal-primary), shows date/time/venue prominently, "Rediger" link to `/admin/meetings/${meeting.id}`, meeting title as heading
- For `previous` variant: compact card with single border, shows title, date, venue in a single row, links to `/admin/meetings/${meeting.id}`
- Format date using `new Date(meeting.date).toLocaleDateString('nb-NO', { day: 'numeric', month: 'long', year: 'numeric' })` — handle null gracefully
- Mobile-first: full-width cards, min-h-[44px] touch targets on links

**Create `src/app/admin/meetings/page.tsx`** — server component:
- Query all meetings ordered by created_at desc: `supabase.from('meetings').select('*').order('created_at', { ascending: false })`
- Separate into `upcomingMeeting` (status === 'upcoming', should be 0 or 1) and `previousMeetings` (status !== 'upcoming')
- Layout:
  - Back arrow link to `/admin`
  - Page title "Møter"
  - If upcomingMeeting exists: render MeetingCard with variant="upcoming"
  - If NO upcomingMeeting: show "Nytt møte" Button (Link to `/admin/meetings/new`)
  - Section "Tidligere møter" with previousMeetings mapped to MeetingCard variant="previous"
  - If no previous meetings: show EmptyState "Ingen tidligere møter ennå"
- Mobile-first layout: max-w-lg mx-auto, p-4

**Create `src/app/admin/meetings/new/page.tsx`** — client component with `'use client'`:
- Use `useActionState` (from 'react') with `createMeeting` action
- Import `createMeeting` from `@/lib/actions/meeting`
- Form fields: date (`<input type="date">`), time (`<input type="time">`), venue (`<Input>` text field)
- All fields wrapped with `<Label>`: "Dato", "Tidspunkt", "Sted"
- Use existing Input component for venue, native inputs for date/time (styled with same h-[44px] min-height, rounded-lg, border patterns)
- Submit button: "Opprett møte" (disabled while pending)
- Error display: show state.error in a red banner if present
- On success (state.id exists): `redirect(`/admin/meetings/${state.id}`)` — use useEffect to detect state.id and call router.push
- Back link to `/admin/meetings`
- Check for existing upcoming meeting on load: if server data indicates one exists, show warning message and disable form. Implementation: pass a prop from a wrapper server component, OR check in the action (action already handles this — rely on action error)

**Create `src/app/admin/meetings/[id]/page.tsx`** — server component (shell for Plan 02):
- Use Next.js 15 async params: `params: Promise<{ id: string }>`
- Await params, query meeting by id: `supabase.from('meetings').select('*').eq('id', id).single()`
- If not found: `notFound()`
- Render meeting title, status badge, date/time/venue info
- Placeholder text: "Stasjoner, grupper og resultat kommer i neste steg" (will be replaced by tabs in Plan 02)
- Back link to `/admin/meetings`
- Show meeting status with Badge component (upcoming=teal, active=coral, completed=secondary)
  </action>
  <verify>
    <automated>cd /Users/mariusvalle-olsen/Github/TbgRuss28 && npx tsc --noEmit --pretty 2>&1 | head -30</automated>
  </verify>
  <done>
- Navigating to /admin/meetings shows overview with upcoming meeting card (or "Nytt mote" button) and previous meetings list
- /admin/meetings/new shows creation form with date, time, venue fields
- Submitting valid form creates meeting and redirects to /admin/meetings/[id]
- /admin/meetings/[id] shows meeting title, status, and placeholder content
- Creating a meeting when one already exists shows error message
  </done>
</task>

</tasks>

<verification>
1. Navigate to /admin — "Møter" card appears as first item, old "Grupper"/"Ordsky"/"Eksporter" cards are gone
2. Click "Møter" — /admin/meetings loads with "Nytt møte" button (no upcoming meeting exists initially)
3. Click "Nytt møte" — /admin/meetings/new shows form with date, time, venue fields
4. Submit form — redirects to /admin/meetings/[id] with meeting info displayed
5. Go back to /admin/meetings — upcoming meeting card shown prominently
6. "Nytt møte" button is gone (upcoming meeting exists)
7. Try creating another meeting via direct URL — action returns error about existing upcoming meeting
8. TypeScript compiles with no errors
</verification>

<success_criteria>
- Admin hub restructured: Møter replaces Grupper/Ordsky/Eksporter
- Meeting CRUD works: create meeting with date/time/venue, see it on overview
- Route structure established: /admin/meetings, /admin/meetings/new, /admin/meetings/[id]
- One-upcoming-meeting constraint enforced in both DB and UX
- All Norwegian labels correct, mobile-first layout with 44px touch targets
</success_criteria>

<output>
After completion, create `.planning/phases/07-admin-meeting-management/07-01-SUMMARY.md`
</output>
