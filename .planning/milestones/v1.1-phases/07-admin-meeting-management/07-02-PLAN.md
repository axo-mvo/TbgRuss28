---
phase: 07-admin-meeting-management
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - src/app/admin/meetings/[id]/page.tsx
  - src/components/admin/MeetingTabs.tsx
  - src/components/admin/StationList.tsx
  - src/components/admin/StationEditor.tsx
  - src/lib/actions/meeting.ts
autonomous: true
requirements: [MEET-02]

must_haves:
  truths:
    - "Meeting detail page shows three tabs: Stasjoner, Grupper, Resultat"
    - "Admin can add a new station with title, questions, and optional tip"
    - "Admin can edit an existing station's title, questions, and tip"
    - "Admin can reorder stations via drag-and-drop and the order persists"
    - "Admin can delete a station"
    - "Stations are read-only when meeting status is active or completed"
  artifacts:
    - path: "src/components/admin/MeetingTabs.tsx"
      provides: "Tab container with Stasjoner/Grupper/Resultat switching"
    - path: "src/components/admin/StationList.tsx"
      provides: "Sortable station list with drag handles and add button"
    - path: "src/components/admin/StationEditor.tsx"
      provides: "Expandable inline station edit form"
    - path: "src/lib/actions/meeting.ts"
      provides: "Station CRUD server actions (addStation, updateStation, deleteStation, reorderStations)"
    - path: "src/app/admin/meetings/[id]/page.tsx"
      provides: "Meeting detail page with full data loading for tabs"
  key_links:
    - from: "src/components/admin/StationList.tsx"
      to: "src/lib/actions/meeting.ts"
      via: "addStation, deleteStation, reorderStations server actions"
      pattern: "addStation|deleteStation|reorderStations"
    - from: "src/components/admin/StationEditor.tsx"
      to: "src/lib/actions/meeting.ts"
      via: "updateStation server action"
      pattern: "updateStation"
    - from: "src/components/admin/StationList.tsx"
      to: "@dnd-kit/react"
      via: "DragDropProvider for sortable station reorder"
      pattern: "DragDropProvider"
    - from: "src/app/admin/meetings/[id]/page.tsx"
      to: "src/components/admin/MeetingTabs.tsx"
      via: "Server component passes meeting + stations data to client tabs"
      pattern: "MeetingTabs.*meeting.*stations"
---

<objective>
Build the meeting detail page with tabbed layout and full station CRUD (add, edit, reorder, delete) using drag-and-drop.

Purpose: Admin can fully configure stations for a meeting, which is the core content setup needed before groups and meeting activation.
Output: Tab component, station list with drag-and-drop reorder, inline station editor, station CRUD server actions.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-admin-meeting-management/07-RESEARCH.md
@.planning/phases/07-admin-meeting-management/07-CONTEXT.md
@.planning/phases/07-admin-meeting-management/07-01-SUMMARY.md

@src/lib/actions/meeting.ts
@src/app/admin/meetings/[id]/page.tsx
@src/components/admin/GroupBuilder.tsx
@src/components/ui/Button.tsx
@src/components/ui/Input.tsx
@src/components/ui/Label.tsx
@src/components/ui/Dialog.tsx

<interfaces>
<!-- Key types and contracts the executor needs. -->

From @dnd-kit/react (v0.3.x — the rewrite, NOT @dnd-kit/core):
```typescript
import { DragDropProvider } from '@dnd-kit/react'
import { move } from '@dnd-kit/helpers'
// DragDropProvider wraps sortable items
// move(items, event) handles reorder state updates
// See GroupBuilder.tsx for the exact usage pattern in this codebase
```

From GroupBuilder.tsx (drag-and-drop pattern to replicate):
```typescript
<DragDropProvider
  onDragOver={(event) => { setItems((items) => move(items, event)) }}
  onDragEnd={(event) => { /* persist to server */ }}
>
  {/* Sortable items with unique ids */}
</DragDropProvider>
```

From supabase/migrations/020_meetings_migration.sql (stations schema):
```sql
-- stations table columns: id, meeting_id, number, title, description, questions (JSONB), tip, created_at
-- Compound unique: idx_stations_meeting_number ON stations(meeting_id, number)
-- questions column stores JSON array of strings
```

Meeting type (from Plan 01 — will exist after 07-01 executes):
```typescript
interface Meeting {
  id: string; title: string; status: 'upcoming' | 'active' | 'completed';
  date: string | null; time: string | null; venue: string | null;
  created_at: string; updated_at: string;
}
```

Station type (from DB schema):
```typescript
interface Station {
  id: string; meeting_id: string; number: number; title: string;
  description: string | null; questions: string[]; // JSONB array
  tip: string | null; created_at: string;
}
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Station CRUD server actions</name>
  <files>src/lib/actions/meeting.ts</files>
  <action>
**Add station CRUD server actions to `src/lib/actions/meeting.ts`** (append to file created in Plan 01):

1. **`addStation(meetingId: string, data: { title: string; questions: string; tip?: string })`** → `Promise<{ error?: string; station?: { id: string; number: number } }>`:
   - verifyAdmin()
   - Check meeting status is 'upcoming': `admin.from('meetings').select('status').eq('id', meetingId).single()` — if not upcoming, return `{ error: 'Kan bare redigere stasjoner for kommende møter' }`
   - Get next station number: `admin.from('stations').select('number').eq('meeting_id', meetingId).order('number', { ascending: false }).limit(1).maybeSingle()` — use `(maxRow?.number ?? 0) + 1`
   - Parse questions from textarea: `data.questions.split('\n').map(q => q.trim()).filter(Boolean)` — store as JSON array
   - Insert: `admin.from('stations').insert({ meeting_id: meetingId, number: nextNumber, title: data.title.trim(), questions: questionsArray, tip: data.tip?.trim() || null, description: null }).select('id, number').single()`
   - `revalidatePath(`/admin/meetings/${meetingId}`)`
   - Return `{ station: { id, number } }`

2. **`updateStation(stationId: string, meetingId: string, data: { title: string; questions: string; tip?: string })`** → `Promise<{ error?: string }>`:
   - verifyAdmin()
   - Check meeting is upcoming (same pattern)
   - Parse questions same as addStation
   - `admin.from('stations').update({ title: data.title.trim(), questions: questionsArray, tip: data.tip?.trim() || null }).eq('id', stationId).eq('meeting_id', meetingId)`
   - revalidatePath

3. **`deleteStation(stationId: string, meetingId: string)`** → `Promise<{ error?: string }>`:
   - verifyAdmin()
   - Check meeting is upcoming
   - `admin.from('stations').delete().eq('id', stationId).eq('meeting_id', meetingId)`
   - After deletion, re-number remaining stations: query all stations for this meeting ordered by number, update each station's number to its index + 1 (maintains sequential numbering)
   - revalidatePath

4. **`reorderStations(meetingId: string, orderedIds: string[])`** → `Promise<{ error?: string }>`:
   - verifyAdmin()
   - Check meeting is upcoming
   - Loop through orderedIds, update each station's `number` to `index + 1`: `admin.from('stations').update({ number: i + 1 }).eq('id', orderedIds[i]).eq('meeting_id', meetingId)`
   - revalidatePath

All actions follow the same verifyAdmin + createAdminClient pattern. All check meeting status before mutation.
  </action>
  <verify>
    <automated>cd /Users/mariusvalle-olsen/Github/TbgRuss28 && npx tsc --noEmit --pretty 2>&1 | head -30</automated>
  </verify>
  <done>
- Four new server actions exported from meeting.ts: addStation, updateStation, deleteStation, reorderStations
- All check meeting status before allowing mutation
- Station numbers are auto-assigned and maintained sequentially
- TypeScript compiles cleanly
  </done>
</task>

<task type="auto">
  <name>Task 2: Meeting detail tabs, station list with drag-and-drop, and inline editor</name>
  <files>src/app/admin/meetings/[id]/page.tsx, src/components/admin/MeetingTabs.tsx, src/components/admin/StationList.tsx, src/components/admin/StationEditor.tsx</files>
  <action>
**Update `src/app/admin/meetings/[id]/page.tsx`** — server component:
- Keep async params pattern from Plan 01
- Query meeting AND its stations: `admin.from('stations').select('*').eq('meeting_id', id).order('number')` (parallel with meeting query using Promise.all)
- Also query groups count for this meeting: `admin.from('groups').select('*', { count: 'exact', head: true }).eq('meeting_id', id)` — pass count to tabs for lifecycle prereq display
- Pass meeting, stations, and groupCount to `<MeetingTabs>` client component
- Keep back link and meeting title/status display above tabs

**Create `src/components/admin/MeetingTabs.tsx`** — `'use client'`:
- Props: `meeting: Meeting, stations: Station[], groupCount: number`
- State: `activeTab: 'stasjoner' | 'grupper' | 'resultat'` (default 'stasjoner')
- Tab bar: flex container with 3 equal-width buttons, bottom border-b, active tab gets `border-b-2 border-teal-primary text-teal-primary`, inactive gets `text-text-muted`
- Tab labels: "Stasjoner", "Grupper", "Resultat" — short for mobile
- Content: conditionally render based on activeTab
  - `stasjoner`: `<StationList meeting={meeting} initialStations={stations} />`
  - `grupper`: placeholder `<p className="text-text-muted text-sm p-4">Grupper kommer i neste plan</p>` (wired in Plan 03)
  - `resultat`: placeholder `<p className="text-text-muted text-sm p-4">Resultat kommer i neste plan</p>` (wired in Plan 03)

**Create `src/components/admin/StationList.tsx`** — `'use client'`:
- Props: `meeting: Meeting, initialStations: Station[]`
- State: `stations` array (initialized from initialStations), `adding` boolean
- Determine `readOnly` from `meeting.status !== 'upcoming'`
- If readOnly: show stations as a static list (no drag handles, no add/delete buttons)
- If editable (upcoming):
  - Wrap in `<DragDropProvider>` from `@dnd-kit/react` — follow the exact same pattern as GroupBuilder.tsx
  - `onDragOver`: use `move` from `@dnd-kit/helpers` to update local state
  - `onDragEnd`: call `reorderStations(meeting.id, orderedIds)` server action to persist
  - Each station item shows: drag handle (grip icon, left side), station number badge, station title, expand/collapse chevron
  - Collapsed state: single row with number + title + drag handle
  - Expanded state: renders `<StationEditor>` inline
  - "Legg til stasjon" button at bottom — calls `addStation` server action, adds new station to local state on success
  - Each station has a delete button (trash icon) with confirmation via Dialog component
- Mobile-first: full-width items, 44px min-height rows, clear touch targets on drag handles

**Create `src/components/admin/StationEditor.tsx`** — `'use client'`:
- Props: `station: Station, meetingId: string, onSave: (updated: Station) => void, onCancel: () => void, readOnly: boolean`
- If readOnly: display station fields as text (no inputs)
- If editable:
  - Fields: title (Input component), questions (textarea — display as joined newlines from JSON array, user edits as line-separated text), tip (Input component, optional)
  - "Lagre" button — calls `updateStation` server action, then `onSave` callback with updated data
  - "Avbryt" button — calls `onCancel`
  - Show saving state on button
- Labels in Norwegian: "Tittel", "Spørsmål (ett per linje)", "Tips (valgfritt)"
- Textarea for questions: min-h-[100px], same styling as Input (border, rounded-lg, focus ring)

**Important implementation notes:**
- Use `@dnd-kit/react` (v0.3.x rewrite), NOT `@dnd-kit/core`. Import `DragDropProvider` from `@dnd-kit/react` and `move` from `@dnd-kit/helpers`. Follow GroupBuilder.tsx exactly for the DnD pattern.
- Questions are stored as JSONB array in DB but displayed as newline-separated text in textarea. Convert both ways.
- Station `description` column exists but is not exposed in the admin editor per CONTEXT.md (title, questions, tip only).
  </action>
  <verify>
    <automated>cd /Users/mariusvalle-olsen/Github/TbgRuss28 && npx tsc --noEmit --pretty 2>&1 | head -30</automated>
  </verify>
  <done>
- Meeting detail page shows three tabs: Stasjoner, Grupper, Resultat
- Stasjoner tab displays sortable station list with drag handles (upcoming meetings) or read-only list (active/completed)
- Admin can add a station with title, questions, and optional tip
- Admin can expand a station to edit its fields inline
- Admin can drag-and-drop to reorder stations — order persists after page refresh
- Admin can delete a station with confirmation dialog
- Grupper and Resultat tabs show placeholder text (wired in Plan 03)
  </done>
</task>

</tasks>

<verification>
1. Navigate to /admin/meetings/[id] for an upcoming meeting — three tabs visible
2. Stasjoner tab shows empty state initially, "Legg til stasjon" button at bottom
3. Add a station — form appears, fill title + questions + tip, save — station appears in list
4. Add 3 stations — all show with sequential numbers
5. Drag station 3 to position 1 — order updates, refresh page — new order persists
6. Expand station 2 — edit title — save — title updates
7. Delete station — confirmation dialog — station removed, remaining re-numbered
8. For a completed meeting: stations display in read-only mode, no add/delete/drag controls
9. TypeScript compiles with no errors
</verification>

<success_criteria>
- Tab navigation works on mobile (equal-width touch targets)
- Station CRUD: add, edit, reorder (drag-and-drop), delete all functional
- Read-only mode enforced for non-upcoming meetings
- Drag-and-drop uses @dnd-kit/react pattern from GroupBuilder
- Questions stored as JSONB array, displayed as newline-separated text
- All Norwegian labels, 44px touch targets, mobile-first layout
</success_criteria>

<output>
After completion, create `.planning/phases/07-admin-meeting-management/07-02-SUMMARY.md`
</output>
