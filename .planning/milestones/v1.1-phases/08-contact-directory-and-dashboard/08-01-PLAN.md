# Plan 08-01: Per-Meeting Attendance Schema and Server Actions

---
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/021_meeting_attendance.sql
  - src/lib/actions/attendance.ts
  - src/components/dashboard/AttendingToggle.tsx
requirements:
  - SCOPE-02
autonomous: true
---

## Goal

Create the `meeting_attendance` junction table that tracks attendance per meeting (replacing the global `profiles.attending` boolean), build dedicated server actions for per-meeting attendance upsert, and update the AttendingToggle component to accept meeting context so it writes to the new table.

## must_haves

- [ ] `meeting_attendance` table exists with `(meeting_id, user_id)` unique constraint, proper RLS policies, and performance indexes
- [ ] A migration script that backfills existing `profiles.attending` data into the `meeting_attendance` table for the most recent non-completed meeting (if one exists)
- [ ] Server action `updateMeetingAttendance(meetingId, attending)` upserts a row in `meeting_attendance` using the admin client and `ON CONFLICT ... DO UPDATE`
- [ ] `AttendingToggle` component accepts `meetingId`, `meetingTitle`, `meetingDate`, `meetingTime`, `meetingVenue` props and calls the new per-meeting action instead of the global `updateAttending`
- [ ] The old `updateAttending` action in `auth.ts` is NOT deleted (backward compat) but `AttendingToggle` no longer calls it

## Context for Executor

### Existing patterns to follow
- Server actions pattern: see `src/lib/actions/auth.ts` (`updateAttending`) and `src/lib/actions/meeting.ts` for `verifyAdmin` pattern
- Admin client usage: `createAdminClient()` from `@/lib/supabase/admin` for bypassing RLS
- RLS policy patterns: see `supabase/migrations/020_meetings_migration.sql` for authenticated-user policies
- Migration numbering: latest is `020_meetings_migration.sql`, this should be `021_meeting_attendance.sql`
- `AttendingToggle` current implementation: `src/components/dashboard/AttendingToggle.tsx` -- hardcoded meeting info, calls `updateAttending` from `auth.ts`

### Key decisions
- Use admin client for the attendance upsert (the RLS `INSERT` policy uses `user_id = auth.uid()` but the upsert pattern with `onConflict` works better through admin client to avoid RLS complications with UPSERT)
- Keep `profiles.attending` column -- do NOT drop it. Mark it deprecated in comments. Will be removed in a future cleanup.
- Phone prefix for Norwegian numbers: `+47` (8-digit numbers)
- Date formatting: use `toLocaleDateString('nb-NO')` for Norwegian date display

### Schema details (from research)
```sql
CREATE TABLE meeting_attendance (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  meeting_id UUID NOT NULL REFERENCES meetings(id) ON DELETE CASCADE,
  user_id UUID NOT NULL REFERENCES profiles(id) ON DELETE CASCADE,
  attending BOOLEAN NOT NULL,
  updated_at TIMESTAMPTZ DEFAULT now(),
  UNIQUE(meeting_id, user_id)
);
```

RLS policies needed:
1. All authenticated users can SELECT (dashboard counts)
2. Users can INSERT their own attendance (`user_id = auth.uid()`)
3. Users can UPDATE their own attendance
4. Admins can manage all attendance via `public.is_admin()`

### AttendingToggle redesign
The component must display dynamic meeting info instead of hardcoded text. New props:
```typescript
interface AttendingToggleProps {
  meetingId: string
  meetingTitle: string
  meetingDate: string    // ISO date string
  meetingTime: string    // HH:MM string
  meetingVenue: string
  initialAttending: boolean | null
}
```

Format the meeting info as: `"{title}" - {date formatted} kl. {time}` on first line, venue on second line.

### Server action signature
```typescript
// src/lib/actions/attendance.ts
export async function updateMeetingAttendance(
  meetingId: string,
  attending: boolean
): Promise<{ error?: string }>
```
- Authenticate via `supabase.auth.getUser()` (not admin-only -- any authenticated user can set their own attendance)
- Use `createAdminClient()` for the `.upsert()` call to avoid RLS upsert complexity
- Call `revalidatePath('/dashboard')` on success

<tasks>
<task id="08-01-01" title="Create meeting_attendance migration and attendance server action">
**Files to create:**
- `supabase/migrations/021_meeting_attendance.sql`
- `src/lib/actions/attendance.ts`

**Migration file (`021_meeting_attendance.sql`):**
1. Create `meeting_attendance` table with columns: `id` (UUID PK), `meeting_id` (FK to meetings), `user_id` (FK to profiles), `attending` (BOOLEAN NOT NULL), `updated_at` (TIMESTAMPTZ)
2. Add `UNIQUE(meeting_id, user_id)` constraint
3. Enable RLS
4. Create 4 RLS policies:
   - `"Authenticated users can view meeting attendance"` -- SELECT for authenticated, USING (true)
   - `"Users can manage own attendance"` -- INSERT for authenticated, WITH CHECK (user_id = auth.uid())
   - `"Users can update own attendance"` -- UPDATE for authenticated, USING/WITH CHECK (user_id = auth.uid())
   - `"Admins can manage all attendance"` -- ALL for authenticated, USING/WITH CHECK (public.is_admin())
5. Create indexes: `idx_meeting_attendance_meeting_id`, `idx_meeting_attendance_user_id`
6. Backfill existing `profiles.attending` data: find most recent non-completed meeting, INSERT INTO meeting_attendance from profiles WHERE attending IS NOT NULL
7. Add comment: `-- Note: profiles.attending column NOT dropped -- deprecated, will be removed in future cleanup`

**Server action (`src/lib/actions/attendance.ts`):**
1. `'use server'` directive
2. Import `createClient` from server, `createAdminClient` from admin, `revalidatePath` from next/cache
3. Export `updateMeetingAttendance(meetingId: string, attending: boolean): Promise<{ error?: string }>`
4. Get authenticated user via `supabase.auth.getUser()`
5. Use admin client `.upsert()` with `{ meeting_id: meetingId, user_id: user.id, attending, updated_at: new Date().toISOString() }` and `{ onConflict: 'meeting_id,user_id' }`
6. On error return `{ error: 'Kunne ikke oppdatere oppmøtestatus' }`
7. On success call `revalidatePath('/dashboard')` and return `{}`

**Verification:**
- Migration SQL is valid and can be copy-pasted into Supabase Dashboard SQL Editor
- Server action handles auth, upsert, error cases, and revalidation
</task>

<task id="08-01-02" title="Update AttendingToggle to use per-meeting attendance">
**File to modify:**
- `src/components/dashboard/AttendingToggle.tsx`

**Changes:**
1. Update the `AttendingToggleProps` interface to include: `meetingId: string`, `meetingTitle: string`, `meetingDate: string`, `meetingTime: string`, `meetingVenue: string`, `initialAttending: boolean | null`
2. Replace the import of `updateAttending` from `@/lib/actions/auth` with `updateMeetingAttendance` from `@/lib/actions/attendance`
3. In `handleSelect`, call `updateMeetingAttendance(meetingId, value)` instead of `updateAttending(value)` (keep the same optimistic update pattern with `useTransition`)
4. Replace the hardcoded title `"Fellesmote onsdag kl. 18:00 - Greveskogen VGS"` with dynamic content:
   - Format: `{meetingTitle}` as the heading
   - Below: `{formatted date} kl. {meetingTime} — {meetingVenue}` as secondary text
   - Date formatting: `new Date(meetingDate + 'T00:00:00').toLocaleDateString('nb-NO', { weekday: 'long', day: 'numeric', month: 'long' })` -- capitalize first letter
5. Keep the "Kommer du?" prompt, the "Du har ikke svart enna" italic text, and the Ja/Nei button pair exactly as they are (just change the action call)
6. Ensure all existing styles, min-h-[44px] touch targets, and transition classes are preserved

**Verification:**
- Component accepts new props and renders dynamic meeting info
- Calls `updateMeetingAttendance` with correct meetingId
- Norwegian date formatting works (e.g., "onsdag 26. februar")
- TypeScript compiles without errors
</task>
</tasks>

## Verification Criteria

1. **Schema**: `meeting_attendance` table has correct columns, constraints, RLS policies, and indexes
2. **Backfill**: Existing attendance data from `profiles.attending` is migrated to the most recent non-completed meeting
3. **Action**: `updateMeetingAttendance` correctly upserts attendance for authenticated users
4. **Component**: AttendingToggle displays dynamic meeting info and calls the new per-meeting action
5. **No regressions**: The old `updateAttending` action in `auth.ts` is untouched
