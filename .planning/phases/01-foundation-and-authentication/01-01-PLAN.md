---
phase: 01-foundation-and-authentication
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - tsconfig.json
  - next.config.ts
  - postcss.config.mjs
  - .env.local.example
  - src/app/globals.css
  - src/app/layout.tsx
  - src/app/page.tsx
  - src/lib/supabase/client.ts
  - src/lib/supabase/server.ts
  - src/lib/supabase/admin.ts
  - src/middleware.ts
  - supabase/migrations/001_schema.sql
  - supabase/migrations/002_rls.sql
  - supabase/migrations/003_functions.sql
  - supabase/migrations/004_seed.sql
  - src/components/ui/Button.tsx
  - src/components/ui/Input.tsx
  - src/components/ui/Card.tsx
  - src/components/ui/Label.tsx
  - src/components/ui/Badge.tsx
autonomous: true
requirements:
  - AUTH-05
  - DSGN-01
  - DSGN-02
  - DSGN-03
user_setup:
  - service: supabase
    why: "Database, authentication, and realtime backend"
    env_vars:
      - name: NEXT_PUBLIC_SUPABASE_URL
        source: "Supabase Dashboard -> Project Settings -> API -> Project URL"
      - name: NEXT_PUBLIC_SUPABASE_ANON_KEY
        source: "Supabase Dashboard -> Project Settings -> API -> anon/public key (or sb_publishable_* key)"
      - name: SUPABASE_SERVICE_ROLE_KEY
        source: "Supabase Dashboard -> Project Settings -> API -> service_role key (or sb_secret_* key)"
    dashboard_config:
      - task: "Create a new Supabase project (free tier)"
        location: "https://supabase.com/dashboard -> New Project"
      - task: "Disable email confirmation for registration"
        location: "Supabase Dashboard -> Authentication -> Providers -> Email -> Toggle OFF 'Confirm email'"
      - task: "Run migration SQL files in order (001-004) in the SQL Editor"
        location: "Supabase Dashboard -> SQL Editor -> paste each file and run"

must_haves:
  truths:
    - "Next.js 15 app starts with `npm run dev` and renders a Norwegian-language page"
    - "Tailwind CSS v4 custom theme colors (teal-primary, coral, warm-white) are available as utility classes"
    - "Three Supabase client utilities exist and compile without type errors"
    - "Middleware intercepts requests and redirects unauthenticated users to /login"
    - "Database schema includes profiles, invite_codes, parent_youth_links, groups, group_members, stations, station_sessions, messages, and meeting_status tables"
    - "RLS policies are defined for all tables"
    - "validate_invite_code() SQL function exists and atomically checks + increments uses"
    - "Seed data includes 6 stations and 2 invite codes (one youth, one parent)"
  artifacts:
    - path: "src/app/layout.tsx"
      provides: "Root layout with <html lang='nb'>, Tailwind import, Norwegian metadata"
      contains: "lang=\"nb\""
    - path: "src/app/globals.css"
      provides: "Tailwind v4 theme with custom colors"
      contains: "@theme"
    - path: "src/lib/supabase/client.ts"
      provides: "Browser Supabase client singleton"
      contains: "createBrowserClient"
    - path: "src/lib/supabase/server.ts"
      provides: "Per-request server Supabase client"
      contains: "await cookies()"
    - path: "src/lib/supabase/admin.ts"
      provides: "Service-role admin client (bypasses RLS)"
      contains: "SUPABASE_SERVICE_ROLE_KEY"
    - path: "src/middleware.ts"
      provides: "Auth middleware with getClaims() and public route allowlist"
      contains: "getClaims"
    - path: "supabase/migrations/001_schema.sql"
      provides: "Database tables"
      contains: "CREATE TABLE"
    - path: "supabase/migrations/003_functions.sql"
      provides: "Database functions"
      contains: "validate_invite_code"
    - path: "supabase/migrations/004_seed.sql"
      provides: "Seed data for stations and invite codes"
      contains: "INSERT INTO stations"
  key_links:
    - from: "src/lib/supabase/server.ts"
      to: "src/middleware.ts"
      via: "Same createServerClient pattern with cookie handlers"
      pattern: "createServerClient"
    - from: "src/app/globals.css"
      to: "src/app/layout.tsx"
      via: "CSS import in root layout"
      pattern: "import.*globals\\.css"
    - from: "src/middleware.ts"
      to: "Supabase Auth"
      via: "getClaims() validates JWT signature"
      pattern: "getClaims"
---

<objective>
Scaffold the Next.js 15 project with Supabase infrastructure, database schema, and a mobile-first Norwegian design system.

Purpose: Establish the complete foundation that all subsequent plans depend on -- Supabase client utilities, auth middleware, database tables with RLS and functions, and the Tailwind v4 design system with custom colors.

Output: A running Next.js 15 app with three Supabase client utilities, auth middleware, four SQL migration files, a Tailwind v4 theme with the project color palette, reusable UI primitives, and a Norwegian-language root layout.
</objective>

<execution_context>
@/Users/mariusvalle-olsen/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mariusvalle-olsen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-and-authentication/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Scaffold Next.js 15 project, Tailwind v4 theme, UI primitives, and root layout</name>
  <files>
    package.json
    tsconfig.json
    next.config.ts
    postcss.config.mjs
    .env.local.example
    src/app/globals.css
    src/app/layout.tsx
    src/app/page.tsx
    src/components/ui/Button.tsx
    src/components/ui/Input.tsx
    src/components/ui/Card.tsx
    src/components/ui/Label.tsx
    src/components/ui/Badge.tsx
  </files>
  <action>
    1. **Create the Next.js 15 project** using `npx create-next-app@latest . --typescript --eslint --app --tailwind --src-dir --import-alias "@/*" --use-npm` (run from the project root). If create-next-app installs Next.js 16, pin to Next.js 15: `npm install next@15 react@19 react-dom@19`.

    2. **Install Supabase dependencies**: `npm install @supabase/supabase-js @supabase/ssr`

    3. **Verify Tailwind CSS v4 setup**. create-next-app should set up Tailwind v4 with `@tailwindcss/postcss`. If not, install: `npm install tailwindcss@latest @tailwindcss/postcss postcss`. Ensure `postcss.config.mjs` contains:
       ```js
       const config = { plugins: { "@tailwindcss/postcss": {} } };
       export default config;
       ```
       Delete `tailwind.config.ts` or `tailwind.config.js` if created -- Tailwind v4 uses CSS-first config.

    4. **Configure `src/app/globals.css`** with the Tailwind v4 theme:
       ```css
       @import "tailwindcss";

       @theme {
         --color-teal-primary: #1B4D5C;
         --color-teal-secondary: #2A7F8E;
         --color-coral: #E8734A;
         --color-coral-light: #F09A7D;
         --color-warm-white: #FBF8F4;
         --color-text-primary: #1E2D3D;
         --color-text-muted: #3A4F5E;
         --color-success: #2D8A56;
         --color-warning: #E8A838;
         --color-danger: #D94040;
         --font-sans: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
       }
       ```

    5. **Create `src/app/layout.tsx`** -- Root layout with Norwegian locale:
       - `<html lang="nb">` for Norwegian bokmal
       - Body classes: `bg-warm-white text-text-primary font-sans antialiased min-h-dvh`
       - Metadata: `title: 'Buss 2028 Fellesmote'`, `description: 'Diskusjonsapp for fellesmote'`
       - Import `./globals.css`

    6. **Create `src/app/page.tsx`** -- Simple landing page that redirects to `/login`. Use `redirect('/login')` from `next/navigation` in a Server Component.

    7. **Create `.env.local.example`** with placeholder values:
       ```
       NEXT_PUBLIC_SUPABASE_URL=your-supabase-url
       NEXT_PUBLIC_SUPABASE_ANON_KEY=your-supabase-anon-key
       SUPABASE_SERVICE_ROLE_KEY=your-supabase-service-role-key
       ```

    8. **Create 5 reusable UI primitives** in `src/components/ui/`. Each is a simple wrapper around HTML elements with Tailwind classes for the project design system. All must be mobile-first (touch targets min 44px height for interactive elements).

       - **Button.tsx**: `'use client'`. Props: `children`, `variant` ('primary' | 'secondary' | 'danger'), `type`, `disabled`, `className`, `onClick`. Primary: `bg-teal-primary text-white hover:bg-teal-secondary`. Secondary: `bg-white text-teal-primary border border-teal-primary`. Danger: `bg-danger text-white`. All: `min-h-[44px] px-6 py-3 rounded-lg font-medium transition-colors disabled:opacity-50 w-full`.

       - **Input.tsx**: Forwarded ref component. Props: `label` (optional), `error` (optional string), plus standard input props. Styling: `w-full px-4 py-3 min-h-[44px] rounded-lg border border-gray-300 focus:border-teal-primary focus:ring-2 focus:ring-teal-primary/20 bg-white`. Show error text in `text-danger text-sm mt-1` if error prop present.

       - **Card.tsx**: Props: `children`, `className`. Styling: `bg-white rounded-xl shadow-sm border border-gray-100 p-5`.

       - **Label.tsx**: Props: `children`, `htmlFor`, `className`. Styling: `block text-sm font-medium text-text-primary mb-1.5`.

       - **Badge.tsx**: Props: `children`, `variant` ('youth' | 'parent' | 'admin'), `className`. Youth: `bg-teal-primary/10 text-teal-primary`. Parent: `bg-coral/10 text-coral`. Admin: `bg-warning/10 text-warning`. All: `inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium`.

    9. **Verify** the app compiles and starts: `npm run build` should succeed (or at minimum `npm run dev` starts without crash). Fix any TypeScript or Tailwind compilation errors.
  </action>
  <verify>
    Run `npm run build` from the project root. It should complete without errors. Check that `src/app/globals.css` contains `@theme` with `--color-teal-primary`. Check that `src/app/layout.tsx` contains `lang="nb"`. Check that all 5 UI component files exist in `src/components/ui/`.
  </verify>
  <done>
    Next.js 15 project compiles. Tailwind v4 theme has custom colors (teal-primary, coral, warm-white). Root layout uses Norwegian locale. Five UI primitives exist with mobile-first styling. `.env.local.example` documents required env vars.
  </done>
</task>

<task type="auto">
  <name>Task 2: Three Supabase client utilities, auth middleware, and database migrations</name>
  <files>
    src/lib/supabase/client.ts
    src/lib/supabase/server.ts
    src/lib/supabase/admin.ts
    src/middleware.ts
    supabase/migrations/001_schema.sql
    supabase/migrations/002_rls.sql
    supabase/migrations/003_functions.sql
    supabase/migrations/004_seed.sql
  </files>
  <action>
    1. **Create `src/lib/supabase/client.ts`** -- Browser client singleton:
       ```typescript
       import { createBrowserClient } from '@supabase/ssr'

       export function createClient() {
         return createBrowserClient(
           process.env.NEXT_PUBLIC_SUPABASE_URL!,
           process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
         )
       }
       ```

    2. **Create `src/lib/supabase/server.ts`** -- Per-request server client. CRITICAL: `await cookies()` (Next.js 15 async API). Uses `createServerClient` from `@supabase/ssr` with getAll/setAll cookie handlers. The setAll must wrap in try/catch because Server Components have read-only cookies. See Research code example exactly.

    3. **Create `src/lib/supabase/admin.ts`** -- Service-role client for privileged operations:
       ```typescript
       import { createClient } from '@supabase/supabase-js'

       export function createAdminClient() {
         return createClient(
           process.env.NEXT_PUBLIC_SUPABASE_URL!,
           process.env.SUPABASE_SERVICE_ROLE_KEY!,
           {
             auth: {
               autoRefreshToken: false,
               persistSession: false,
             },
           }
         )
       }
       ```

    4. **Create `src/middleware.ts`** -- Auth token refresh + unauthenticated redirect:
       - Create a Supabase server client using `createServerClient` with request cookies (NOT `await cookies()` -- middleware uses `request.cookies` directly).
       - Call `supabase.auth.getClaims()` to validate the JWT locally. **IMPORTANT:** If `getClaims()` is not available in the installed version of `@supabase/supabase-js`, fall back to `supabase.auth.getUser()`. Check for the method's existence first: `if (typeof supabase.auth.getClaims === 'function')`.
       - Define public routes: `['/login', '/register', '/auth']`.
       - If no authenticated user AND not a public route, redirect to `/login`.
       - If authenticated user AND on `/login` or `/register`, redirect to `/dashboard` (prevent logged-in users from seeing auth pages).
       - Export `config.matcher` that excludes static files: `'/((?!_next/static|_next/image|favicon.ico|.*\\.(?:svg|png|jpg|jpeg|gif|webp)$).*)'`

    5. **Create `supabase/migrations/001_schema.sql`** -- Database tables:
       - `profiles` (id UUID PK references auth.users, full_name TEXT NOT NULL, email TEXT NOT NULL, role TEXT NOT NULL CHECK (role IN ('admin', 'youth', 'parent')), created_at TIMESTAMPTZ DEFAULT now())
       - `invite_codes` (id UUID PK DEFAULT gen_random_uuid(), code TEXT UNIQUE NOT NULL, role TEXT NOT NULL CHECK (role IN ('youth', 'parent')), max_uses INT DEFAULT 100, uses INT DEFAULT 0, active BOOLEAN DEFAULT true, created_at TIMESTAMPTZ DEFAULT now())
       - `parent_youth_links` (id UUID PK DEFAULT gen_random_uuid(), parent_id UUID NOT NULL REFERENCES profiles(id), youth_id UUID NOT NULL REFERENCES profiles(id), created_at TIMESTAMPTZ DEFAULT now(), UNIQUE(parent_id, youth_id))
       - `groups` (id UUID PK DEFAULT gen_random_uuid(), name TEXT NOT NULL, locked BOOLEAN DEFAULT false, created_at TIMESTAMPTZ DEFAULT now())
       - `group_members` (id UUID PK DEFAULT gen_random_uuid(), group_id UUID NOT NULL REFERENCES groups(id), user_id UUID NOT NULL REFERENCES profiles(id), created_at TIMESTAMPTZ DEFAULT now(), UNIQUE(group_id, user_id))
       - `stations` (id UUID PK DEFAULT gen_random_uuid(), number INT UNIQUE NOT NULL, title TEXT NOT NULL, description TEXT, questions JSONB DEFAULT '[]', tip TEXT, created_at TIMESTAMPTZ DEFAULT now())
       - `station_sessions` (id UUID PK DEFAULT gen_random_uuid(), station_id UUID NOT NULL REFERENCES stations(id), group_id UUID NOT NULL REFERENCES groups(id), status TEXT NOT NULL DEFAULT 'available' CHECK (status IN ('available', 'active', 'completed')), started_at TIMESTAMPTZ, end_timestamp TIMESTAMPTZ, completed_at TIMESTAMPTZ, created_at TIMESTAMPTZ DEFAULT now(), UNIQUE(station_id, group_id))
       - `messages` (id UUID PK DEFAULT gen_random_uuid(), session_id UUID NOT NULL REFERENCES station_sessions(id), user_id UUID NOT NULL REFERENCES profiles(id), content TEXT NOT NULL, created_at TIMESTAMPTZ DEFAULT now())
       - `meeting_status` (id UUID PK DEFAULT gen_random_uuid(), status TEXT NOT NULL DEFAULT 'pending' CHECK (status IN ('pending', 'active', 'completed')), started_at TIMESTAMPTZ, ended_at TIMESTAMPTZ)
       - Enable RLS on ALL tables: `ALTER TABLE <table> ENABLE ROW LEVEL SECURITY;`
       - Add indexes: `CREATE INDEX idx_messages_session_id ON messages(session_id);`, `CREATE INDEX idx_messages_created_at ON messages(created_at);`, `CREATE INDEX idx_group_members_user_id ON group_members(user_id);`, `CREATE INDEX idx_group_members_group_id ON group_members(group_id);`

    6. **Create `supabase/migrations/002_rls.sql`** -- RLS policies:
       - `profiles`: Authenticated users can SELECT their own row. Admin can SELECT all. INSERT via service role only (registration uses admin client).
       - `invite_codes`: Anon and authenticated can SELECT active codes. UPDATE via service role only (atomic increment in function).
       - `parent_youth_links`: Authenticated users can SELECT their own links. INSERT via service role only.
       - `groups`: Authenticated can SELECT all groups (needed for dashboard).
       - `group_members`: Authenticated can SELECT all members (needed to check group membership). INSERT/DELETE admin only.
       - `stations`: Authenticated can SELECT all stations.
       - `station_sessions`: Authenticated can SELECT sessions for their group. INSERT/UPDATE for group members.
       - `messages`: Authenticated can SELECT messages for sessions in their group. Authenticated can INSERT messages for sessions in their group.
       - `meeting_status`: Authenticated can SELECT. Admin can UPDATE.
       - Use `auth.uid()` for user identification in policies.
       - For "admin" checks, create a helper: `CREATE OR REPLACE FUNCTION public.is_admin() RETURNS BOOLEAN AS $$ SELECT EXISTS (SELECT 1 FROM profiles WHERE id = auth.uid() AND role = 'admin'); $$ LANGUAGE sql SECURITY DEFINER STABLE;`

    7. **Create `supabase/migrations/003_functions.sql`** -- Database functions:
       - `validate_invite_code(p_code TEXT)` -- Returns JSON: `{valid: boolean, role: text, error: text}`. Checks code exists, is active, and uses < max_uses. If valid, atomically increments uses with `UPDATE invite_codes SET uses = uses + 1 WHERE id = <found_id> AND uses < max_uses RETURNING *`. If the UPDATE returns 0 rows, another user claimed the last spot (race condition handled). Mark as `SECURITY DEFINER` so it runs with table owner privileges (bypasses RLS for the atomic update).

    8. **Create `supabase/migrations/004_seed.sql`** -- Seed data:
       - 6 stations with Norwegian titles and questions (JSONB arrays):
         1. "Fellesskap og Samhold" (4 questions about community)
         2. "Inkludering" (4 questions about inclusion)
         3. "Rus og Forebygging" (4 questions about substance prevention)
         4. "Budsjett og Okonomi" (4 questions about budgeting)
         5. "Finansiering" (4 questions about financing)
         6. "Nye Regler for Russebuss" (4 questions about regulation changes)
       - Each station: number (1-6), title, description (1-2 sentence Norwegian summary), questions (JSONB array of 4 question strings in Norwegian), tip (short Norwegian guidance text).
       - 2 invite codes: `{code: 'UNGDOM2028', role: 'youth', max_uses: 50}`, `{code: 'FORELDER2028', role: 'parent', max_uses: 60}`
       - 1 meeting_status row: `{status: 'pending'}`
       - Use INSERT with ON CONFLICT DO NOTHING so seed is idempotent.

    9. **Verify** TypeScript compilation of all Supabase client files and middleware: `npx tsc --noEmit` (or `npm run build`). Verify SQL files have valid syntax by visual inspection (no runtime DB to test against yet).
  </action>
  <verify>
    Run `npm run build` -- should succeed with no type errors. Verify files exist: `src/lib/supabase/client.ts`, `src/lib/supabase/server.ts`, `src/lib/supabase/admin.ts`, `src/middleware.ts`, and all 4 SQL files in `supabase/migrations/`. Grep for `getClaims` or `getUser` in `src/middleware.ts` to confirm auth check is present. Grep for `validate_invite_code` in `003_functions.sql`. Grep for `UNGDOM2028` in `004_seed.sql`.
  </verify>
  <done>
    Three Supabase client utilities compile without errors. Middleware intercepts requests and redirects unauthenticated users. Four SQL migration files define the complete database schema with RLS, functions, and seed data. The validate_invite_code function atomically handles concurrent usage.
  </done>
</task>

</tasks>

<verification>
1. `npm run dev` starts without errors
2. `npm run build` completes successfully
3. Visiting `http://localhost:3000` redirects to `/login` (middleware + root page redirect)
4. All 5 UI components exist in `src/components/ui/`
5. `src/app/layout.tsx` contains `lang="nb"` and `bg-warm-white`
6. `src/app/globals.css` contains `@theme` with `--color-teal-primary: #1B4D5C`
7. Three Supabase client files exist and export their factory functions
8. `src/middleware.ts` uses `getClaims()` (or `getUser()` fallback) and defines public route allowlist
9. Four SQL migration files exist with complete schema, RLS, functions, and seed data
</verification>

<success_criteria>
- Next.js 15 app compiles and starts with `npm run dev`
- Tailwind v4 custom colors (teal-primary, coral, warm-white) work in utility classes
- Norwegian locale set in root layout (`lang="nb"`)
- Mobile-safe viewport (`min-h-dvh`) used instead of `h-screen`
- Three Supabase client utilities compile without type errors
- Auth middleware redirects unauthenticated users to `/login`
- Database schema covers all 9 tables with RLS enabled
- `validate_invite_code()` function handles race conditions atomically
- Seed data includes 6 Norwegian stations and 2 invite codes
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-and-authentication/01-01-SUMMARY.md`
</output>
