---
phase: 01-foundation-and-authentication
plan: 02
type: execute
wave: 2
depends_on:
  - 01-01
files_modified:
  - src/lib/actions/auth.ts
  - src/components/auth/RegisterForm.tsx
  - src/components/auth/LoginForm.tsx
  - src/app/register/page.tsx
  - src/app/login/page.tsx
  - src/app/dashboard/layout.tsx
  - src/app/dashboard/page.tsx
  - src/app/admin/layout.tsx
  - src/app/admin/page.tsx
autonomous: true
requirements:
  - AUTH-01
  - AUTH-02
  - AUTH-03
  - AUTH-04
  - AUTH-05

must_haves:
  truths:
    - "User can enter an invite code and proceed to the registration form only if the code is valid"
    - "Invite code determines whether the user registers as youth or parent"
    - "Parent registering sees a dropdown of already-registered youth and can select their child(ren)"
    - "User can register with name, email, and password -- and a profile row is created in the database"
    - "User can log in with email and password"
    - "After login, admin users are redirected to /admin and youth/parent users to /dashboard"
    - "The /admin route is protected -- non-admin users are redirected to /dashboard"
    - "All form labels, buttons, and error messages are in Norwegian (bokmal)"
  artifacts:
    - path: "src/lib/actions/auth.ts"
      provides: "Server Actions for validateInviteCode, register, login, logout, getRegisteredYouth"
      contains: "use server"
    - path: "src/components/auth/RegisterForm.tsx"
      provides: "Multi-step registration form with invite code validation, parent child-linking"
      contains: "use client"
    - path: "src/components/auth/LoginForm.tsx"
      provides: "Login form with email/password"
      contains: "use client"
    - path: "src/app/register/page.tsx"
      provides: "Registration page (Server Component shell)"
      contains: "RegisterForm"
    - path: "src/app/login/page.tsx"
      provides: "Login page (Server Component shell)"
      contains: "LoginForm"
    - path: "src/app/dashboard/layout.tsx"
      provides: "Auth guard for participant routes"
      contains: "redirect"
    - path: "src/app/dashboard/page.tsx"
      provides: "Participant dashboard placeholder"
      contains: "Velkommen"
    - path: "src/app/admin/layout.tsx"
      provides: "Admin guard -- redirects non-admin to /dashboard"
      contains: "role !== 'admin'"
    - path: "src/app/admin/page.tsx"
      provides: "Admin dashboard placeholder"
      contains: "Admin"
  key_links:
    - from: "src/components/auth/RegisterForm.tsx"
      to: "src/lib/actions/auth.ts"
      via: "Calls validateInviteCode, getRegisteredYouth, register Server Actions"
      pattern: "validateInviteCode|register|getRegisteredYouth"
    - from: "src/components/auth/LoginForm.tsx"
      to: "src/lib/actions/auth.ts"
      via: "Calls login Server Action"
      pattern: "login"
    - from: "src/lib/actions/auth.ts"
      to: "src/lib/supabase/server.ts"
      via: "Creates server Supabase client for auth operations"
      pattern: "createClient"
    - from: "src/lib/actions/auth.ts"
      to: "src/lib/supabase/admin.ts"
      via: "Creates admin client for profile creation (bypasses RLS)"
      pattern: "createAdminClient"
    - from: "src/app/dashboard/layout.tsx"
      to: "src/lib/supabase/server.ts"
      via: "Checks auth state, redirects if not authenticated"
      pattern: "getUser"
    - from: "src/app/admin/layout.tsx"
      to: "profiles table"
      via: "Queries profile role, redirects non-admin to /dashboard"
      pattern: "role.*admin"
---

<objective>
Implement the complete registration flow (invite code validation, multi-step form with parent child-linking), login flow, and role-based routing with layout guards.

Purpose: Enable users to register with invite codes, log in, and be routed to the correct dashboard -- completing all AUTH requirements. This is the user-facing authentication experience built on top of Plan 01's infrastructure.

Output: Server Actions for auth operations, registration and login forms, protected dashboard pages with layout guards, all with Norwegian UI text.
</objective>

<execution_context>
@/Users/mariusvalle-olsen/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mariusvalle-olsen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-and-authentication/01-RESEARCH.md
@.planning/phases/01-foundation-and-authentication/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Server Actions for invite code validation, registration, login, and logout</name>
  <files>
    src/lib/actions/auth.ts
  </files>
  <action>
    Create `src/lib/actions/auth.ts` with `'use server'` directive. This file contains ALL auth-related Server Actions.

    **1. `validateInviteCode(code: string)`**
    - Uses `createAdminClient()` (admin client -- no auth required for code validation).
    - Calls `supabase.rpc('validate_invite_code', { p_code: code })`.
    - Returns `{ valid: boolean, role?: 'youth' | 'parent', error?: string }`.
    - On error/invalid: returns `{ valid: false, error: 'Ugyldig invitasjonskode' }`.
    - On success: returns `{ valid: true, role: data.role }`.
    - NOTE: This does NOT atomically increment yet -- the validate_invite_code function does both validation AND atomic increment. Clarify: the SQL function should be split into two: `check_invite_code` (read-only) and the actual increment happens during `register`. ACTUALLY -- keep it simple: the SQL function validates AND increments atomically. So calling `validateInviteCode` on the form step WILL increment the counter. This is fine because if the user abandons registration, the code just has one fewer available use, which is acceptable for this small-scale event. If this is a concern, modify the SQL function to only validate without incrementing, and increment during registration. For simplicity, use the atomic validate+increment approach from the research.

    **CORRECTION:** On reflection, the invite code should only be validated (not incremented) at the validation step, and incremented at the registration step. Otherwise, users who validate but don't complete registration consume uses. Create two approaches:
    - `validateInviteCode`: Queries `invite_codes` directly via admin client -- SELECT where code matches, active=true, uses < max_uses. Returns role. Does NOT increment.
    - `register`: Calls the `validate_invite_code` SQL RPC function (which atomically validates + increments) as the first step, before creating the auth user. If the RPC returns invalid (e.g., code was used up between validation and registration), return an error.

    **2. `getRegisteredYouth()`**
    - Uses `createAdminClient()` (anon users can't read profiles due to RLS).
    - Queries `profiles` table: SELECT id, full_name WHERE role='youth', ORDER BY full_name ASC.
    - Returns `{ youth: Array<{id: string, full_name: string}>, error: string | null }`.

    **3. `register(formData: FormData)`**
    - Extracts: email, password, fullName, inviteCode, role, youthIds (array).
    - Step 1: Call `validate_invite_code` RPC via admin client (atomic validate + increment). If invalid, return `{ error: 'Invitasjonskoden er ugyldig eller brukt opp' }`.
    - Step 2: Create auth user via server client (`await createClient()` from server.ts): `supabase.auth.signUp({ email, password, options: { data: { full_name: fullName, role } } })`. If error (e.g., email taken), return `{ error: authError.message }`.
    - Step 3: Create profile row via admin client: `adminClient.from('profiles').insert({ id: authData.user.id, full_name: fullName, email, role })`. If error, rollback by deleting the auth user: `adminClient.auth.admin.deleteUser(authData.user.id)`, then return `{ error: 'Kunne ikke opprette profil' }`.
    - Step 4: If role='parent' and youthIds.length > 0, insert parent_youth_links via admin client. Non-fatal error (log but don't fail registration).
    - Step 5: `revalidatePath('/', 'layout')` then `redirect('/dashboard')`.

    **4. `login(formData: FormData)`**
    - Extracts email, password from formData.
    - Uses server client: `supabase.auth.signInWithPassword({ email, password })`.
    - If error: return `{ error: 'Feil e-post eller passord' }`.
    - After successful login, query profile role via server client.
    - `revalidatePath('/', 'layout')`.
    - If role='admin': `redirect('/admin')`. Else: `redirect('/dashboard')`.

    **5. `logout()`**
    - Uses server client: `supabase.auth.signOut()`.
    - `revalidatePath('/', 'layout')`.
    - `redirect('/login')`.

    **Error handling pattern:** All Server Actions return `{ error?: string }` on failure. On success they either return data or call `redirect()`. The `redirect()` call throws internally (Next.js behavior) -- do NOT wrap it in try/catch. Place `redirect()` AFTER all try/catch blocks.

    **CRITICAL:** `redirect()` from `next/navigation` throws a special error. It must NOT be inside a try/catch. Pattern:
    ```typescript
    let redirectPath: string | null = null
    try {
      // ... logic ...
      redirectPath = '/dashboard'
    } catch (e) {
      return { error: '...' }
    }
    if (redirectPath) {
      revalidatePath('/', 'layout')
      redirect(redirectPath)
    }
    ```
  </action>
  <verify>
    Run `npx tsc --noEmit` (or `npm run build`). The file should compile without type errors. Grep for all 5 function exports: `validateInviteCode`, `getRegisteredYouth`, `register`, `login`, `logout`. Verify `'use server'` is at the top of the file.
  </verify>
  <done>
    Five Server Actions compile without errors: validateInviteCode (read-only check), getRegisteredYouth (returns youth list), register (atomic invite code increment + auth user + profile + parent-youth links), login (email/password with role-based redirect), logout. All error messages are in Norwegian.
  </done>
</task>

<task type="auto">
  <name>Task 2: Registration form, login form, protected dashboard pages, and layout guards</name>
  <files>
    src/components/auth/RegisterForm.tsx
    src/components/auth/LoginForm.tsx
    src/app/register/page.tsx
    src/app/login/page.tsx
    src/app/dashboard/layout.tsx
    src/app/dashboard/page.tsx
    src/app/admin/layout.tsx
    src/app/admin/page.tsx
  </files>
  <action>
    **1. Create `src/components/auth/RegisterForm.tsx`** -- `'use client'` component.

    Multi-step registration form with 3 steps:

    **Step 1: Invite Code**
    - Single input field for invite code.
    - "Bekreft kode" button calls `validateInviteCode(code)` Server Action.
    - On success: store the returned `role` in state, advance to Step 2.
    - On error: show error message below input in `text-danger`.

    **Step 2: User Details**
    - Fields: Fullt navn (full name), E-post (email), Passord (password, type="password", minLength=6).
    - If role is 'parent': also show a multi-select dropdown for child linking (Step 2b integrated).
      - On mount (useEffect), call `getRegisteredYouth()` to fetch youth list.
      - Show a list of checkboxes with youth names. Label: "Velg ditt/dine barn".
      - If no youth registered yet, show info text: "Ingen ungdommer er registrert enn√•. Du kan koble til barn senere."
    - "Registrer deg" button submits all data via `register` Server Action using a FormData object.
    - Show loading state on button during submission (disabled + "Registrerer...").

    **Form state management:** Use `useState` for step, role, error, loading, selectedYouthIds. Use native form submission pattern with Server Actions (create FormData manually and call the action).

    **Layout:** Single-column, centered on screen. Max width 400px. Use Card component as container. Use Input, Label, Button components from `src/components/ui/`. Mobile-first: full width on mobile, centered with padding on larger screens.

    **Step indicator:** Show "Steg 1 av 2" / "Steg 2 av 2" at the top of the card. For parents, still show "Steg 2 av 2" (child selection is part of step 2, not a separate step).

    **2. Create `src/components/auth/LoginForm.tsx`** -- `'use client'` component.

    - Fields: E-post (email), Passord (password).
    - "Logg inn" button calls `login` Server Action.
    - Use `useState` for error and loading state.
    - On error: show error message in `text-danger`.
    - Loading state: button disabled + "Logger inn...".
    - Below form: "Har du ikke konto?" link to `/register`.
    - Layout: Same Card-centered pattern as RegisterForm.

    **3. Create `src/app/register/page.tsx`** -- Server Component shell.
    - Renders a centered layout with the app title "Buss 2028 Fellesmote" as heading.
    - Renders `<RegisterForm />`.
    - Text: "Registrer deg" as page heading.

    **4. Create `src/app/login/page.tsx`** -- Server Component shell.
    - Renders a centered layout with the app title.
    - Renders `<LoginForm />`.
    - Text: "Logg inn" as page heading.

    **5. Create `src/app/dashboard/layout.tsx`** -- Auth guard (defense-in-depth).
    - Server Component. Uses `createClient()` from `@/lib/supabase/server` (await).
    - Calls `supabase.auth.getUser()`. If no user, `redirect('/login')`.
    - Passes `children` through.

    **6. Create `src/app/dashboard/page.tsx`** -- Participant dashboard placeholder.
    - Server Component.
    - Uses server Supabase client to get user and query profile (full_name, role).
    - Displays: "Velkommen, {full_name}!" heading. Badge component showing role. "Du er logget inn som {role}" text.
    - Logout button (form with `action={logout}`).
    - Placeholder text: "Dashbordet er under utvikling. Stasjoner og gruppechat kommer snart."
    - Mobile-first layout: full-width padding, single column.

    **7. Create `src/app/admin/layout.tsx`** -- Admin guard.
    - Server Component. Uses server Supabase client.
    - Calls `getUser()`. If no user, `redirect('/login')`.
    - Queries `profiles` for role. If `role !== 'admin'`, `redirect('/dashboard')`.
    - Passes `children` through.

    **8. Create `src/app/admin/page.tsx`** -- Admin dashboard placeholder.
    - Server Component. Displays: "Adminpanel" heading. Badge with "admin" variant.
    - Placeholder text: "Adminpanelet er under utvikling."
    - Logout button.

    **ALL Norwegian text.** No English strings in any UI component. Button labels, error messages, placeholders, headings -- everything in Norwegian bokmal.
  </action>
  <verify>
    Run `npm run build` -- should succeed. Verify all 8 files exist. Grep for `'use client'` in RegisterForm.tsx and LoginForm.tsx. Grep for `redirect('/login')` in `dashboard/layout.tsx` and `admin/layout.tsx`. Grep for `role !== 'admin'` in `admin/layout.tsx`. Grep for `Velkommen` in `dashboard/page.tsx`. Check that NO English UI strings exist in the form components (no "Submit", "Register", "Login" -- only Norwegian equivalents).
  </verify>
  <done>
    Multi-step registration form with invite code validation, role detection, parent child-linking dropdown, and Norwegian labels. Login form with email/password and Norwegian labels. Dashboard page shows welcome message with user name and role badge. Admin page with admin guard that redirects non-admin users. Layout guards provide defense-in-depth auth checks. All UI text is in Norwegian.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` completes without errors
2. Full registration flow: enter invite code -> validate -> fill details -> register -> redirected to /dashboard
3. Parent registration: after code validation, youth dropdown appears and parent can select children
4. Login flow: enter email/password -> login -> redirected to /dashboard (or /admin for admin users)
5. Dashboard shows "Velkommen, {name}!" with role badge
6. Visiting /admin as non-admin redirects to /dashboard
7. Visiting /dashboard without auth redirects to /login
8. All visible text is in Norwegian (no English UI strings)
</verification>

<success_criteria>
- User can enter a valid invite code and proceed to registration
- Invite code determines youth or parent role
- Parent sees a dropdown of registered youth during registration
- User can register and is redirected to /dashboard
- User can log in and is routed to /admin (admin) or /dashboard (youth/parent)
- Non-admin users cannot access /admin (redirected to /dashboard)
- Unauthenticated users cannot access /dashboard (redirected to /login)
- All form labels, buttons, errors, and page text are in Norwegian
- Forms use mobile-first layout with touch-friendly inputs (min 44px height)
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-and-authentication/01-02-SUMMARY.md`
</output>
