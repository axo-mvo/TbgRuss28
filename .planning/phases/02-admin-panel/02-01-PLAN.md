---
phase: 02-admin-panel
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/005_admin_policies.sql
  - supabase/migrations/006_group_constraints.sql
  - src/lib/actions/admin.ts
  - src/lib/constants/group-names.ts
  - src/components/ui/Dialog.tsx
  - src/components/ui/BottomSheet.tsx
  - src/components/ui/SearchInput.tsx
  - src/components/ui/EmptyState.tsx
  - src/app/admin/page.tsx
autonomous: true
requirements: [ADMN-01, ADMN-02, ADMN-03, ADMN-04, ADMN-05, ADMN-06]

must_haves:
  truths:
    - "Admin server actions exist for all CRUD operations (role change, user deletion, parent-link update, group creation, member assignment, lock/unlock)"
    - "Database has parent-child separation constraint function that rejects placing a parent and their linked child in the same group"
    - "Admin RLS policies allow admin UPDATE/DELETE on profiles and parent_youth_links"
    - "Reusable Dialog, BottomSheet, SearchInput, and EmptyState UI components are available"
    - "Admin hub page has navigation links to user management and group builder sub-pages"
  artifacts:
    - path: "src/lib/actions/admin.ts"
      provides: "All admin server actions"
      exports: ["updateUserRole", "deleteUser", "updateParentYouthLink", "createGroup", "deleteGroup", "saveGroupMembers", "toggleGroupsLock"]
    - path: "supabase/migrations/006_group_constraints.sql"
      provides: "Parent-child separation Postgres function"
      contains: "check_parent_child_separation"
    - path: "src/lib/constants/group-names.ts"
      provides: "Predefined russ group name list"
      contains: "RUSS_GROUP_NAMES"
    - path: "src/components/ui/Dialog.tsx"
      provides: "Confirmation dialog using native <dialog>"
    - path: "src/components/ui/BottomSheet.tsx"
      provides: "Bottom sheet modal using native <dialog>"
  key_links:
    - from: "src/lib/actions/admin.ts"
      to: "src/lib/supabase/admin.ts"
      via: "createAdminClient() for service role mutations"
      pattern: "createAdminClient"
    - from: "src/lib/actions/admin.ts"
      to: "src/lib/supabase/server.ts"
      via: "createClient() for auth verification"
      pattern: "createClient"
---

<objective>
Build the complete backend foundation for Phase 2: database migrations for admin policies and parent-child separation constraint, all Server Actions for admin CRUD operations, reusable UI primitives (Dialog, BottomSheet, SearchInput, EmptyState), predefined russ group names constant, and update the admin hub page with navigation.

Purpose: All subsequent plans (user management UI and group builder UI) depend on these server actions, UI components, and database constraints being in place.
Output: Server actions, DB migrations, UI components, constants, and admin hub page ready for Plan 02 and Plan 03 to build the interactive UIs.
</objective>

<execution_context>
@/Users/mariusvalle-olsen/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mariusvalle-olsen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-admin-panel/02-RESEARCH.md
@.planning/phases/01-foundation-and-authentication/01-01-SUMMARY.md
@.planning/phases/01-foundation-and-authentication/01-02-SUMMARY.md
@supabase/migrations/001_schema.sql
@supabase/migrations/002_rls.sql
@src/lib/supabase/admin.ts
@src/lib/supabase/server.ts
@src/lib/actions/auth.ts
@src/components/ui/Button.tsx
@src/components/ui/Badge.tsx
@src/app/admin/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Database migrations, Server Actions, and group name constants</name>
  <files>
    supabase/migrations/005_admin_policies.sql
    supabase/migrations/006_group_constraints.sql
    src/lib/actions/admin.ts
    src/lib/constants/group-names.ts
  </files>
  <action>
**005_admin_policies.sql** -- Add RLS policies for admin operations:
- Admin can UPDATE profiles (role changes): `CREATE POLICY "Admins can update profiles" ON profiles FOR UPDATE TO authenticated USING (public.is_admin()) WITH CHECK (public.is_admin())`
- Admin can DELETE profiles: `CREATE POLICY "Admins can delete profiles" ON profiles FOR DELETE TO authenticated USING (public.is_admin())`
- Admin can SELECT all parent_youth_links: `CREATE POLICY "Admins can view all parent-youth links" ON parent_youth_links FOR SELECT TO authenticated USING (public.is_admin())`
- Admin can INSERT parent_youth_links: `CREATE POLICY "Admins can create parent-youth links" ON parent_youth_links FOR INSERT TO authenticated WITH CHECK (public.is_admin())`
- Admin can UPDATE parent_youth_links: `CREATE POLICY "Admins can update parent-youth links" ON parent_youth_links FOR UPDATE TO authenticated USING (public.is_admin()) WITH CHECK (public.is_admin())`
- Admin can DELETE parent_youth_links: `CREATE POLICY "Admins can delete parent-youth links" ON parent_youth_links FOR DELETE TO authenticated USING (public.is_admin())`

**006_group_constraints.sql** -- Parent-child separation Postgres function:
- Create function `public.check_parent_child_separation(p_group_id UUID, p_user_id UUID) RETURNS JSON`
- Check 1: Is user a parent with a linked child already in the group? Query `parent_youth_links` joined with `group_members` where `parent_id = p_user_id` and `group_members.group_id = p_group_id`
- Check 2: Is user a youth with a linked parent already in the group? Query `parent_youth_links` joined with `group_members` where `youth_id = p_user_id` and `group_members.group_id = p_group_id`
- Return JSON: `{allowed: true}` or `{allowed: false, reason: "Forelder kan ikke vaere i samme gruppe som sitt barn (name)"}`
- Language: plpgsql, SECURITY DEFINER STABLE
- Follow the exact implementation from 02-RESEARCH.md Pattern 4

**src/lib/constants/group-names.ts** -- Predefined russ group names:
- Export `RUSS_GROUP_NAMES` as a string array with 12+ Norwegian russ group names: 'Trollkraft', 'Vindstyrke', 'Nordlys', 'Stormtropp', 'Fjelltopp', 'Bolgekraft', 'Iskald', 'Lynild', 'Ravnsvart', 'Solskinnet', 'Tordenvaret', 'Midnattsol'

**src/lib/actions/admin.ts** -- All admin Server Actions with 'use server' directive:
- Every action starts with admin verification: get user via `createClient()` + `getUser()`, query profile role, reject if not admin. Use the pattern from 02-RESEARCH.md.
- Every action ends with `revalidatePath()` on the relevant admin path.

Server Actions to implement:

1. `updateUserRole(userId: string, newRole: 'youth' | 'parent' | 'admin')` -- Use admin client to update `profiles.role`. Prevent changing own role. revalidatePath('/admin/users').

2. `deleteUser(userId: string)` -- Prevent self-deletion. Use `admin.auth.admin.deleteUser(userId)` for hard delete (profile cascades via FK). revalidatePath('/admin/users'). Return Norwegian error messages.

3. `updateParentYouthLink(parentId: string, youthIds: string[])` -- Delete existing links for parent, insert new links. revalidatePath('/admin/users').

4. `createGroup()` -- Query existing group names, filter against `RUSS_GROUP_NAMES` to find available names. If none available, return error 'Alle gruppenavn er brukt opp'. Pick random available name. Insert into `groups` table. revalidatePath('/admin/groups'). Return the created group.

5. `deleteGroup(groupId: string)` -- Delete from `groups` (cascades to `group_members`). revalidatePath('/admin/groups').

6. `saveGroupMembers(assignments: { groupId: string; userIds: string[] }[])` -- For each group: delete all existing `group_members` for that group, then insert new members. Before each insert, call `check_parent_child_separation` via `admin.rpc('check_parent_child_separation', { p_group_id, p_user_id })`. If any check fails, return the reason and abort. Wrap the entire operation: clear all groups first, then re-insert. revalidatePath('/admin/groups').

7. `toggleGroupsLock(locked: boolean)` -- Update ALL groups: `groups.update({ locked })`. revalidatePath('/admin/groups'). revalidatePath('/dashboard').

All actions return `{ error?: string }` or `{ error?: string; group?: ... }` for createGroup. Norwegian error messages throughout.
  </action>
  <verify>
Run `npx tsc --noEmit` -- no type errors in the new files. Verify all 7 exports exist in admin.ts. Verify SQL files have valid syntax (no TypeScript compilation needed for SQL, but check they are well-formed).
  </verify>
  <done>
All 7 server actions compile without type errors. Each action has admin verification at the top and revalidatePath at the bottom. Two SQL migration files exist with correct RLS policies and the check_parent_child_separation function. RUSS_GROUP_NAMES constant exports 12+ names.
  </done>
</task>

<task type="auto">
  <name>Task 2: Reusable UI components and admin hub page</name>
  <files>
    src/components/ui/Dialog.tsx
    src/components/ui/BottomSheet.tsx
    src/components/ui/SearchInput.tsx
    src/components/ui/EmptyState.tsx
    src/app/admin/page.tsx
  </files>
  <action>
**src/components/ui/Dialog.tsx** -- Confirmation dialog using native HTML `<dialog>`:
- 'use client' directive
- Props: `open: boolean`, `onClose: () => void`, `onConfirm: () => void`, `title: string`, `description: string`, `confirmLabel?: string` (default 'Bekreft'), `confirmVariant?: 'primary' | 'danger'` (default 'primary'), `loading?: boolean`
- Use `useRef<HTMLDialogElement>` + `useEffect` to call `showModal()` when open, `close()` when closed
- Styled with Tailwind: `rounded-xl p-0 backdrop:bg-black/50 max-w-sm w-[calc(100%-2rem)]`
- Two buttons: "Avbryt" (secondary) and confirm button with the provided label and variant
- When loading, confirm button shows "Laster..." and is disabled
- Follow the exact implementation from 02-RESEARCH.md Code Examples (Confirmation Dialog)

**src/components/ui/BottomSheet.tsx** -- Bottom sheet using native HTML `<dialog>`:
- 'use client' directive
- Props: `open: boolean`, `onClose: () => void`, `title: string`, `children: React.ReactNode`
- Use `useRef<HTMLDialogElement>` + `useEffect` to call `showModal()` when open, `close()` when closed
- Position at bottom of screen: `fixed inset-0 m-0 p-0 w-full max-w-full max-h-[85dvh]`
- Rounded top corners: `rounded-t-2xl`
- Slide-up animation: `translate-y-full open:translate-y-0 transition-transform duration-300 ease-out`
- Content area scrollable: `overflow-y-auto overscroll-contain`
- Header with title and "Lukk" close button (44px touch target)
- Style: `backdrop:bg-black/50`, `self-end`, `margin-top: auto`
- Follow the exact implementation from 02-RESEARCH.md Code Examples (Bottom Sheet)

**src/components/ui/SearchInput.tsx** -- Search input for user filtering:
- 'use client' directive
- Props: `value: string`, `onChange: (value: string) => void`, `placeholder?: string` (default 'Sok...')
- Simple text input with search icon (use a magnifying glass Unicode character or SVG inline)
- Styled to match existing Input component: full width, 44px min-height, rounded-lg, teal focus ring
- Clears on X button when value is non-empty

**src/components/ui/EmptyState.tsx** -- Empty state placeholder:
- No 'use client' needed (pure presentational)
- Props: `title: string`, `description?: string`, `icon?: React.ReactNode`
- Centered layout with muted text styling: text-text-muted, text-center
- Padding: p-8

**src/app/admin/page.tsx** -- Update existing admin hub page:
- Replace the placeholder text with navigation to sub-pages
- Keep the header ("Adminpanel" + Admin badge) and logout form
- Add two navigation cards (using existing Card component if suitable, or plain styled divs):
  - "Brukere" card linking to `/admin/users` -- description: "Administrer brukere, roller og forelder-barn-koblinger"
  - "Grupper" card linking to `/admin/groups` -- description: "Opprett grupper, tildel medlemmer og las gruppene"
- Use Next.js `Link` component for navigation
- Mobile-first layout: cards stack vertically, full width, with gap between them
- Keep the logout button at the bottom
  </action>
  <verify>
Run `npx tsc --noEmit` -- no type errors. Run `npm run build` -- all pages compile. Verify Dialog and BottomSheet are client components (have 'use client'). Verify admin page has Link imports and two card navigation items.
  </verify>
  <done>
Dialog component renders a native `<dialog>` modal with confirm/cancel buttons and loading state. BottomSheet component renders a slide-up dialog from the bottom of the screen. SearchInput renders a text input with clear functionality. EmptyState renders a centered placeholder. Admin hub page shows navigation cards to /admin/users and /admin/groups with a logout button.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `npm run build` succeeds -- all pages compile
3. SQL migration files 005 and 006 exist in supabase/migrations/
4. lib/actions/admin.ts exports all 7 server actions
5. lib/constants/group-names.ts exports RUSS_GROUP_NAMES array
6. 4 new UI components exist in components/ui/
7. Admin page navigates to /admin/users and /admin/groups
</verification>

<success_criteria>
- All server actions compile and follow the admin verification + revalidatePath pattern
- Database migration for parent-child separation constraint is ready to apply
- UI primitives (Dialog, BottomSheet, SearchInput, EmptyState) are reusable for Plans 02 and 03
- Admin hub page provides navigation to sub-pages
- Zero TypeScript errors across all new files
</success_criteria>

<output>
After completion, create `.planning/phases/02-admin-panel/02-01-SUMMARY.md`
</output>
