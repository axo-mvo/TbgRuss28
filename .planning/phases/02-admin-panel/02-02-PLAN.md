---
phase: 02-admin-panel
plan: 02
type: execute
wave: 2
depends_on: [02-01]
files_modified:
  - src/app/admin/users/page.tsx
  - src/components/admin/UserTable.tsx
  - src/components/admin/ParentLinkSheet.tsx
autonomous: true
requirements: [ADMN-01, ADMN-02, ADMN-03]

must_haves:
  truths:
    - "Admin can view a table/card list of all registered users with name, email, role, and registration date"
    - "Admin can search users by name using a text input"
    - "Parent rows show linked youth names as inline badges"
    - "Unlinked parents display a warning badge"
    - "Admin can change a user's role via inline action with confirmation dialog"
    - "Admin can delete a user via inline action with confirmation dialog"
    - "Admin can tap a parent row to open a bottom sheet and re-link to different youth"
  artifacts:
    - path: "src/app/admin/users/page.tsx"
      provides: "Server Component fetching all users with parent-child links"
      contains: "parent_youth_links"
    - path: "src/components/admin/UserTable.tsx"
      provides: "Client component: user table with search, actions, responsive layout"
      contains: "use client"
    - path: "src/components/admin/ParentLinkSheet.tsx"
      provides: "Client component: bottom sheet for parent-youth link editing"
      contains: "BottomSheet"
  key_links:
    - from: "src/app/admin/users/page.tsx"
      to: "src/lib/supabase/server.ts"
      via: "Server Component data fetching with relational join"
      pattern: "parent_youth_links!parent_youth_links_parent_id_fkey"
    - from: "src/components/admin/UserTable.tsx"
      to: "src/lib/actions/admin.ts"
      via: "Calls updateUserRole and deleteUser server actions"
      pattern: "updateUserRole|deleteUser"
    - from: "src/components/admin/ParentLinkSheet.tsx"
      to: "src/lib/actions/admin.ts"
      via: "Calls updateParentYouthLink server action"
      pattern: "updateParentYouthLink"
---

<objective>
Build the user management interface where admin can view all users, search by name, see parent-child links inline, change roles, delete users, and re-link parents to different youth via a bottom sheet.

Purpose: This delivers the admin's primary tool for managing the ~80 registered users before setting up discussion groups.
Output: Fully interactive user management page at /admin/users with mobile-first responsive design.
</objective>

<execution_context>
@/Users/mariusvalle-olsen/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mariusvalle-olsen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-admin-panel/02-RESEARCH.md
@.planning/phases/02-admin-panel/02-01-SUMMARY.md
@src/lib/actions/admin.ts
@src/components/ui/Dialog.tsx
@src/components/ui/BottomSheet.tsx
@src/components/ui/SearchInput.tsx
@src/components/ui/EmptyState.tsx
@src/components/ui/Button.tsx
@src/components/ui/Badge.tsx
@src/components/ui/Card.tsx
@src/app/admin/layout.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: User management Server Component and UserTable client component</name>
  <files>
    src/app/admin/users/page.tsx
    src/components/admin/UserTable.tsx
  </files>
  <action>
**src/app/admin/users/page.tsx** -- Server Component shell:
- Import `createClient` from `@/lib/supabase/server`
- Fetch all profiles with parent-child links using the Supabase relational join syntax with FK disambiguation (from 02-RESEARCH.md):
  ```
  .from('profiles')
  .select(`
    id, full_name, email, role, created_at,
    parent_youth_links!parent_youth_links_parent_id_fkey(
      id,
      youth:profiles!parent_youth_links_youth_id_fkey(id, full_name)
    )
  `)
  .order('created_at', { ascending: false })
  ```
- Also fetch all youth users separately (for the ParentLinkSheet dropdown): `.from('profiles').select('id, full_name').eq('role', 'youth').order('full_name')`
- Pass `users` and `allYouth` as props to `<UserTable>`
- Layout: `min-h-dvh p-4`, `max-w-4xl mx-auto pt-4`, heading "Brukere" with a back link to `/admin`
- Add a back arrow or "Tilbake" link at the top using Next.js Link

**src/components/admin/UserTable.tsx** -- Client Component ('use client'):
- Props: `users` (array with profile + parent_youth_links), `allYouth` (array of {id, full_name})
- Define TypeScript types for the user data shape (inline types, matching Supabase query result)
- State: `searchQuery: string`, `editRoleUser: {id, name, currentRole} | null`, `deleteUserTarget: {id, name} | null`, `parentLinkUser: {id, name, currentYouthIds: string[]} | null`, `loading: boolean`

**Search:**
- Render `<SearchInput>` at the top with placeholder "Sok etter bruker..."
- Filter users by `full_name` matching search query (case-insensitive `.toLowerCase().includes()`)
- Client-side filtering -- no API call needed for ~80 users

**Responsive layout (LOCKED DECISION: table with card stack on mobile):**

Mobile (`< md` breakpoint) -- card stack:
- `div.md:hidden.space-y-3` container
- Each user renders as a card (styled div with `p-4 rounded-xl border border-gray-200 bg-white shadow-sm`)
- Card content:
  - Top row: `full_name` (font-medium) + role Badge (youth/parent/admin) aligned right
  - Second line: email (text-sm text-text-muted)
  - Third line: registration date formatted as Norwegian locale date (`new Date(created_at).toLocaleDateString('nb-NO')`)
  - If user is a parent with linked youth: show linked youth names as small teal badges inline (e.g., "Barn: Ola, Kari")
  - If user is a parent with NO linked youth: show a warning badge in coral/orange: "Ikke koblet til barn"
  - Action buttons row at bottom: "Endre rolle" (secondary variant, small) and "Slett" (danger variant, small)
  - If user is a parent: entire card is tappable (onClick opens ParentLinkSheet)

Desktop (`md:` breakpoint) -- table:
- `div.hidden.md:block` container with `<table className="w-full">`
- Table headers: Navn, E-post, Rolle, Registrert, Handlinger
- Each row shows: full_name (with linked youth badges if parent), email, role Badge, formatted date, action buttons
- If parent with no linked youth: warning badge next to name
- Action buttons: "Endre rolle" and "Slett" as small inline buttons
- If parent: row has cursor-pointer and onClick to open ParentLinkSheet

**Role change flow:**
- Clicking "Endre rolle" sets `editRoleUser` state (opens Dialog)
- Dialog: title "Endre rolle for {name}", description shows current role
- Provide 3 role options as buttons/radio within the dialog body (youth, parent, admin) -- the user selects the new role and confirms
- On confirm: call `updateUserRole(userId, newRole)` server action, show loading state, close dialog on success
- If error returned, show inline error in dialog

**Delete flow:**
- Clicking "Slett" sets `deleteUserTarget` state (opens Dialog)
- Dialog: title "Slett bruker", description "Er du sikker pa at du vil slette {name}? Dette vil fjerne brukeren fra alle grupper.", confirmLabel "Slett", confirmVariant "danger"
- On confirm: call `deleteUser(userId)`, show loading, close on success

**ParentLinkSheet opening:**
- When a parent row/card is tapped, set `parentLinkUser` with parentId, name, and current linked youth IDs
- Render `<ParentLinkSheet>` component (built in Task 2)

**Empty state:**
- If no users match search, show `<EmptyState title="Ingen brukere funnet" description="Prov et annet sokeord" />`
- If no users at all, show `<EmptyState title="Ingen brukere registrert" description="Brukere vil dukke opp her etter at de har registrert seg" />`
  </action>
  <verify>
Run `npx tsc --noEmit` -- no type errors. Run `npm run build` -- users page compiles. Verify the Server Component fetches with FK disambiguation syntax. Verify UserTable has 'use client' directive and responsive layout with md: breakpoint.
  </verify>
  <done>
Admin users page fetches all profiles with parent-child links via Server Component. UserTable renders as card stack on mobile and table on desktop. Users are filterable by name. Role badges and linked youth are visible inline. Role change and delete actions open confirmation dialogs that call server actions. Parents have tappable rows/cards that trigger ParentLinkSheet state.
  </done>
</task>

<task type="auto">
  <name>Task 2: ParentLinkSheet bottom sheet for re-linking parents to youth</name>
  <files>
    src/components/admin/ParentLinkSheet.tsx
  </files>
  <action>
**src/components/admin/ParentLinkSheet.tsx** -- Client Component ('use client'):
- Props: `open: boolean`, `onClose: () => void`, `parentId: string`, `parentName: string`, `currentYouthIds: string[]`, `allYouth: { id: string; full_name: string }[]`

- Render `<BottomSheet>` with title "Koblinger for {parentName}"
- Content:
  - List of all youth with checkboxes (each youth = a row with checkbox + name)
  - Pre-check the checkboxes for `currentYouthIds`
  - State: `selectedYouthIds: string[]` initialized from `currentYouthIds`
  - Checkbox toggling updates `selectedYouthIds`
  - If no youth exist in the system, show EmptyState: "Ingen ungdommer registrert enna"

- Footer (inside the BottomSheet content, at bottom):
  - "Lagre" button (primary) -- calls `updateParentYouthLink(parentId, selectedYouthIds)` server action
  - Loading state while saving
  - On success: call `onClose()`
  - On error: show error message inline above the button

- Styling:
  - Youth list items: `flex items-center gap-3 py-3 border-b border-gray-100 last:border-0`
  - Checkbox: `w-5 h-5 accent-teal-primary` (native checkbox with teal accent)
  - Youth name: `text-text-primary`
  - Save button: full width at bottom with `mt-4`
  - Min touch targets: 44px height for each youth row

- Integration with UserTable:
  - UserTable renders `<ParentLinkSheet>` conditionally when `parentLinkUser` state is set
  - Pass props from parentLinkUser state
  - onClose clears the parentLinkUser state
  </action>
  <verify>
Run `npx tsc --noEmit` -- no type errors. Verify ParentLinkSheet imports BottomSheet from '@/components/ui/BottomSheet'. Verify it calls updateParentYouthLink from '@/lib/actions/admin'. Run `npm run build` -- all pages compile.
  </verify>
  <done>
ParentLinkSheet renders inside a BottomSheet with a checkbox list of all youth. Admin can check/uncheck youth to link/unlink from the parent. Save button calls the updateParentYouthLink server action. Sheet closes on successful save. Integrated with UserTable via conditional rendering.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `npm run build` succeeds
3. /admin/users page fetches users with parent-child links from Server Component
4. UserTable renders responsive layout: cards on mobile, table on desktop
5. Search filters users by name client-side
6. Parent rows show linked youth names; unlinked parents show warning badge
7. Role change and delete actions trigger confirmation dialogs and call server actions
8. ParentLinkSheet opens for parent rows and allows re-linking to youth
</verification>

<success_criteria>
- Admin can view all users with name, email, role, and registration date (ADMN-01)
- Admin can see which youth each parent is linked to (ADMN-02)
- Admin can change role or delete a user with confirmation (ADMN-03)
- Admin can re-link parents to different youth via bottom sheet (ADMN-02 edit)
- Unlinked parents show a warning badge
- Mobile-first responsive layout with card stack on mobile and table on desktop
- All text in Norwegian
</success_criteria>

<output>
After completion, create `.planning/phases/02-admin-panel/02-02-SUMMARY.md`
</output>
