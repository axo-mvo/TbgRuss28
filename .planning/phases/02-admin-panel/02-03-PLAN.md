---
phase: 02-admin-panel
plan: 03
type: execute
wave: 2
depends_on: [02-01]
files_modified:
  - src/app/admin/groups/page.tsx
  - src/components/admin/GroupBuilder.tsx
  - src/components/admin/GroupBucket.tsx
  - src/components/admin/UserCard.tsx
  - src/components/admin/UnassignedPool.tsx
  - src/lib/utils/parent-child.ts
  - src/app/dashboard/page.tsx
autonomous: true
requirements: [ADMN-04, ADMN-05, ADMN-06]

must_haves:
  truths:
    - "Admin can create discussion groups that get randomly assigned names from the predefined russ group name list"
    - "Admin can assign users to groups via drag-and-drop on desktop"
    - "Admin can assign users to groups via tap-to-assign on mobile"
    - "Admin receives a warning when trying to place a parent and their linked child in the same group"
    - "Admin can delete empty groups"
    - "Admin can save group assignments which are validated by the database constraint"
    - "Admin can lock groups, after which participants see their group name on the dashboard"
    - "Admin can unlock groups to make further changes"
  artifacts:
    - path: "src/app/admin/groups/page.tsx"
      provides: "Server Component fetching groups, members, users, and parent-child links"
      contains: "GroupBuilder"
    - path: "src/components/admin/GroupBuilder.tsx"
      provides: "Client component: drag-and-drop group assignment with DragDropProvider"
      contains: "DragDropProvider"
    - path: "src/components/admin/GroupBucket.tsx"
      provides: "Droppable group container with group name and member list"
      contains: "useSortable"
    - path: "src/components/admin/UserCard.tsx"
      provides: "Draggable user card showing name, role, and conflict warning"
      contains: "useSortable"
    - path: "src/lib/utils/parent-child.ts"
      provides: "Client-side conflict detection utility"
      exports: ["checkConflict"]
    - path: "src/app/dashboard/page.tsx"
      provides: "Updated dashboard showing group assignment when groups are locked"
      contains: "group_members"
  key_links:
    - from: "src/components/admin/GroupBuilder.tsx"
      to: "@dnd-kit/react"
      via: "DragDropProvider for drag-and-drop orchestration"
      pattern: "DragDropProvider"
    - from: "src/components/admin/GroupBuilder.tsx"
      to: "src/lib/actions/admin.ts"
      via: "Calls createGroup, deleteGroup, saveGroupMembers, toggleGroupsLock"
      pattern: "createGroup|saveGroupMembers|toggleGroupsLock"
    - from: "src/components/admin/GroupBuilder.tsx"
      to: "src/lib/utils/parent-child.ts"
      via: "Client-side conflict detection before save"
      pattern: "checkConflict"
    - from: "src/app/dashboard/page.tsx"
      to: "group_members joined with groups"
      via: "Query for locked group membership"
      pattern: "group_members"
---

<objective>
Build the group builder interface with drag-and-drop (desktop) and tap-to-assign (mobile), parent-child separation enforcement, group creation with random russ names, lock/unlock flow, and update the participant dashboard to show group assignment when locked.

Purpose: This is the core admin workflow for the meeting day -- creating groups and assigning ~80 users while ensuring parents and their children are in separate groups.
Output: Fully interactive group builder at /admin/groups with real-time conflict detection, and participant dashboard showing group assignment after locking.
</objective>

<execution_context>
@/Users/mariusvalle-olsen/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mariusvalle-olsen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-admin-panel/02-RESEARCH.md
@.planning/phases/02-admin-panel/02-01-SUMMARY.md
@src/lib/actions/admin.ts
@src/lib/constants/group-names.ts
@src/lib/utils/parent-child.ts
@src/components/ui/Dialog.tsx
@src/components/ui/Button.tsx
@src/components/ui/Badge.tsx
@src/components/ui/EmptyState.tsx
@src/app/dashboard/page.tsx
@src/app/admin/layout.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Group builder page with drag-and-drop, tap-to-assign, and conflict detection</name>
  <files>
    src/app/admin/groups/page.tsx
    src/components/admin/GroupBuilder.tsx
    src/components/admin/GroupBucket.tsx
    src/components/admin/UserCard.tsx
    src/components/admin/UnassignedPool.tsx
    src/lib/utils/parent-child.ts
  </files>
  <action>
**First: install dependencies**
Run `npm install @dnd-kit/react @dnd-kit/helpers` before creating files.

**src/lib/utils/parent-child.ts** -- Client-side conflict detection:
- Export `checkConflict(groupMembers: string[], userId: string, parentChildLinks: Map<string, string[]>): { conflict: boolean; reason?: string }`
- Check if userId is a parent with a child already in groupMembers (using parentChildLinks map: parentId -> youthId[])
- Check if userId is a youth with a parent already in groupMembers (reverse lookup)
- Return `{ conflict: false }` or `{ conflict: true, reason: "Forelder-barn-konflikt" }`
- Also export `buildParentChildMap(links: { parent_id: string; youth_id: string }[]): Map<string, string[]>` helper

**src/app/admin/groups/page.tsx** -- Server Component shell:
- Fetch all non-admin users: `profiles.select('id, full_name, role').neq('role', 'admin').order('full_name')`
- Fetch all groups with their members: `groups.select('id, name, locked, group_members(user_id)').order('created_at')`
- Fetch all parent-youth links: `parent_youth_links.select('parent_id, youth_id')`
- Transform data into initial state: `Record<string, string[]>` where keys are group IDs + 'unassigned', values are user ID arrays
- Determine which users are unassigned (not in any group_members)
- Pass to `<GroupBuilder>`: initialGroups state, users array, parentChildLinks array, groupsLocked boolean (derived from any group having locked=true)
- Layout: `min-h-dvh p-4`, `max-w-6xl mx-auto pt-4`, heading "Grupper" with back link to `/admin`

**src/components/admin/GroupBuilder.tsx** -- Client Component ('use client'):
- Props: `initialGroups: Record<string, string[]>` (groupId -> userIds, plus 'unassigned' key), `users: { id: string; full_name: string; role: string }[]`, `parentChildLinks: { parent_id: string; youth_id: string }[]`, `groupNames: Record<string, string>` (groupId -> name), `initialLocked: boolean`
- State:
  - `groups: Record<string, string[]>` -- current assignment state
  - `groupNames: Record<string, string>` -- group ID to name mapping
  - `locked: boolean` -- current lock state
  - `saving: boolean`, `error: string | null`
  - `showLockDialog: boolean`, `showDeleteGroupDialog: string | null`
  - `mobileAssignUser: string | null` -- for mobile tap-to-assign flow

- Build `parentChildMap` using `buildParentChildMap()` utility on mount

**Top action bar:**
- "Opprett gruppe" button (primary) -- calls `createGroup()` server action, adds returned group to local state
- "Lagre endringer" button (secondary) -- calls `saveGroupMembers()` with current assignments, shows loading, handles errors
- Lock toggle: "Las grupper" / "Las opp grupper" button -- opens confirmation Dialog, then calls `toggleGroupsLock(!locked)`
- When locked: show a green status badge "Grupper er last" and disable drag-and-drop, hide create/save buttons
- When unlocked: show all controls

**Desktop drag-and-drop (md: breakpoint and above):**
- Wrap everything in `<DragDropProvider>` from `@dnd-kit/react`
- On `onDragOver` event: use `move()` from `@dnd-kit/helpers` to update local `groups` state
- On `onDragEnd` event: check for parent-child conflicts in the target group. If conflict detected, revert the move and show a toast/inline warning. Use `checkConflict()` utility.
- Render `<UnassignedPool>` (the unassigned bucket) and `<GroupBucket>` for each group
- Each user in the pools rendered as `<UserCard>` (draggable)

**Mobile tap-to-assign (below md: breakpoint):**
- Instead of drag-and-drop, show a different interaction:
- Each user card has a "Tildel" button. Tapping it sets `mobileAssignUser` state.
- When `mobileAssignUser` is set, show a Dialog/bottom sheet listing available groups. Admin taps a group name to assign the user.
- Check for parent-child conflicts before assignment. If conflict, show warning in the selection UI.
- After assignment, update local `groups` state.
- Use `<div className="md:hidden">` for mobile layout and `<div className="hidden md:block">` for desktop layout.

**src/components/admin/UnassignedPool.tsx** -- Client Component:
- Props: `id: string` (always 'unassigned'), `userIds: string[]`, `users: Map<string, UserData>`, `parentChildMap: Map<string, string[]>`, `isMobile?: boolean`
- If desktop: renders as a droppable container using `useSortable` with `group: 'unassigned'`
- Heading: "Ikke tildelt ({count})"
- Renders UserCard for each user in the pool
- Styled: `p-4 rounded-xl border-2 border-dashed border-gray-300 bg-gray-50 min-h-[120px]`
- Empty state: "Alle brukere er tildelt en gruppe"

**src/components/admin/GroupBucket.tsx** -- Client Component:
- Props: `groupId: string`, `groupName: string`, `userIds: string[]`, `users: Map<string, UserData>`, `parentChildMap: Map<string, string[]>`, `onDelete: () => void`, `locked: boolean`, `isMobile?: boolean`
- If desktop: droppable container using `useSortable` with `group: groupId`
- Heading: group name + member count + delete button (X icon, only when empty and unlocked)
- Renders UserCard for each user in the group
- If a user has a conflict in this group, UserCard shows the conflict warning
- Styled: `p-4 rounded-xl border border-gray-200 bg-white shadow-sm min-h-[120px]`
- When locked: visual indicator (lock icon or subtle locked styling)

**src/components/admin/UserCard.tsx** -- Client Component:
- Props: `id: string`, `index: number`, `column: string`, `userName: string`, `userRole: string`, `hasConflict: boolean`, `locked: boolean`, `isMobile?: boolean`, `onAssign?: () => void`
- If desktop: use `useSortable({ id, index, type: 'user', accept: 'user', group: column })` from `@dnd-kit/react/sortable`
- Show: user name + role badge (small)
- If hasConflict: red border + "Forelder-barn-konflikt!" warning text in danger color
- If isDragging: `opacity-50 border-teal-primary`
- If locked: no drag handle, muted styling
- If mobile: no drag, but show "Tildel" button (small secondary) when `onAssign` is provided
- Styled: `p-3 rounded-lg border` with conditional border colors
- 44px min-height for touch targets

**Layout of groups:**
- Desktop: CSS grid, `grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4`
- Unassigned pool spans full width above the group grid
- Mobile: single column stack

**Error handling:**
- If `saveGroupMembers` returns an error (parent-child violation from DB), show the error message in a red banner at the top
- If `createGroup` returns "Alle gruppenavn er brukt opp", show error inline
  </action>
  <verify>
Run `npm install @dnd-kit/react @dnd-kit/helpers` -- verify packages installed. Run `npx tsc --noEmit` -- no type errors. Run `npm run build` -- groups page compiles. Verify GroupBuilder imports from '@dnd-kit/react'. Verify parent-child.ts exports checkConflict and buildParentChildMap.
  </verify>
  <done>
Group builder page fetches all users, groups, and parent-child links via Server Component. GroupBuilder client component provides drag-and-drop on desktop via @dnd-kit/react and tap-to-assign on mobile. Parent-child conflicts are detected client-side and shown as red warnings. Groups can be created (random russ names), deleted (when empty), and saved. All text in Norwegian.
  </done>
</task>

<task type="auto">
  <name>Task 2: Lock/unlock flow and dashboard group assignment display</name>
  <files>
    src/app/dashboard/page.tsx
  </files>
  <action>
**Lock/unlock integration in GroupBuilder (already wired in Task 1, this task focuses on the dashboard side):**

The lock button and Dialog are already created in Task 1's GroupBuilder. When admin clicks "Las grupper", the `toggleGroupsLock(true)` server action is called, which sets `locked = true` on all groups and calls `revalidatePath('/dashboard')`.

**src/app/dashboard/page.tsx** -- Update existing dashboard to show group assignment:

After the existing profile fetch, add a query for group membership:
```typescript
const { data: membership } = await supabase
  .from('group_members')
  .select(`
    group:groups!inner(id, name, locked)
  `)
  .eq('user_id', user.id)
  .maybeSingle()
```

If `membership` exists and `membership.group.locked === true`:
- Show a new section ABOVE the placeholder text
- Card with teal accent/border:
  - Heading: "Din gruppe"
  - Group name displayed prominently (text-xl font-bold)
  - Subtext: "Du er tildelt denne gruppen for fellesmote-diskusjonene"
- Use the existing Card component or a styled div

If membership exists but group is NOT locked:
- Do NOT show the group name (groups are still being configured)

If no membership:
- Show nothing extra (keep existing placeholder)

Also update the placeholder text:
- If group is locked and assigned: change text from "Dashbordet er under utvikling..." to "Stasjoner og gruppechat blir tilgjengelig nar fellesmotet starter."
- If no group assigned yet: keep existing placeholder text or show "Du er ikke tildelt en gruppe enna. Kontakt admin."

Keep the existing welcome header, role badge, and logout button unchanged.
  </action>
  <verify>
Run `npx tsc --noEmit` -- no type errors. Run `npm run build` -- dashboard page compiles. Verify dashboard queries group_members with groups join. Verify conditional rendering based on locked status.
  </verify>
  <done>
Dashboard page queries the user's group membership. When groups are locked, the participant sees their group name in a prominent card. When groups are not locked or user has no group, the existing placeholder is shown. Lock flow end-to-end: admin locks groups -> revalidatePath('/dashboard') -> participant sees group assignment.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` succeeds -- all pages compile
2. `npx tsc --noEmit` passes with zero errors
3. @dnd-kit/react and @dnd-kit/helpers are in package.json dependencies
4. Group builder page renders with DragDropProvider
5. Groups can be created via createGroup server action
6. Parent-child conflict detection works client-side
7. Lock/unlock toggles group locked state
8. Dashboard shows group assignment when locked
9. All text is in Norwegian
</verification>

<success_criteria>
- Admin can create discussion groups with randomly assigned russ names (ADMN-04)
- Admin can assign members via drag-and-drop (desktop) or tap-to-assign (mobile) (ADMN-04)
- Parent-child separation is enforced with visual warnings and DB constraint (ADMN-05)
- Admin can lock groups, and participants see their group name on the dashboard (ADMN-06)
- Admin can unlock groups to make further changes (ADMN-06)
- Group builder is responsive and mobile-first
- All text in Norwegian
</success_criteria>

<output>
After completion, create `.planning/phases/02-admin-panel/02-03-SUMMARY.md`
</output>
