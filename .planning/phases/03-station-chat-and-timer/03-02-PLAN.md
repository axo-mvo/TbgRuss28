---
phase: 03-station-chat-and-timer
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/app/dashboard/page.tsx
  - src/components/station/StationCard.tsx
  - src/components/station/StationSelector.tsx
  - src/app/dashboard/station/[sessionId]/page.tsx
  - src/components/station/StationHeader.tsx
  - src/components/station/ChatRoom.tsx
  - src/components/station/MessageList.tsx
  - src/components/station/MessageBubble.tsx
  - src/components/station/ChatInput.tsx
  - src/components/station/CountdownTimer.tsx
autonomous: true
requirements: [CHAT-01, CHAT-04, CHAT-05, TIMR-03, TIMR-04]

must_haves:
  truths:
    - "Participant sees 6 station cards on their dashboard with per-group status (available/active/completed)"
    - "Participant can tap an available station card to open the station and enter chat"
    - "Each message shows sender name, role badge (Ungdom/Forelder), timestamp, and content"
    - "Own messages are right-aligned with teal background; others are left-aligned"
    - "Timer displays MM:SS countdown, changes color (white >5min, yellow 1-5min, red <1min)"
    - "At 0:00 timer shows 'Tiden er ute!' and chat remains functional"
  artifacts:
    - path: "src/components/station/StationCard.tsx"
      provides: "Station card for selector grid with status indicator"
      min_lines: 20
    - path: "src/components/station/StationSelector.tsx"
      provides: "Grid of 6 station cards (client component)"
      min_lines: 30
    - path: "src/components/station/ChatRoom.tsx"
      provides: "Main chat container wiring hooks, messages, input, and timer"
      min_lines: 50
    - path: "src/components/station/MessageBubble.tsx"
      provides: "Single message with sender name, role badge, timestamp, own-message styling"
      min_lines: 20
    - path: "src/components/station/ChatInput.tsx"
      provides: "Message input with send-on-enter"
      min_lines: 30
    - path: "src/components/station/CountdownTimer.tsx"
      provides: "Timer display with color transitions"
      min_lines: 15
    - path: "src/app/dashboard/station/[sessionId]/page.tsx"
      provides: "Server component shell for station chat page"
      min_lines: 20
  key_links:
    - from: "src/components/station/ChatRoom.tsx"
      to: "src/lib/hooks/useRealtimeChat.ts"
      via: "hook import and invocation"
      pattern: "useRealtimeChat\\(sessionId"
    - from: "src/components/station/ChatRoom.tsx"
      to: "src/lib/hooks/useCountdownTimer.ts"
      via: "hook import and invocation"
      pattern: "useCountdownTimer\\(endTimestamp"
    - from: "src/components/station/ChatRoom.tsx"
      to: "src/lib/hooks/useAutoScroll.ts"
      via: "hook import and invocation"
      pattern: "useAutoScroll\\(.*messages"
    - from: "src/components/station/ChatRoom.tsx"
      to: "src/lib/actions/station.ts"
      via: "sendMessage server action call"
      pattern: "sendMessage\\("
    - from: "src/components/station/StationSelector.tsx"
      to: "src/lib/actions/station.ts"
      via: "openStation server action call"
      pattern: "openStation\\("
    - from: "src/app/dashboard/page.tsx"
      to: "src/components/station/StationSelector.tsx"
      via: "component import and render"
      pattern: "<StationSelector"
---

<objective>
Build the complete station UI: a station selector on the participant dashboard showing 6 stations with per-group status, and a chat page with real-time messaging, sender identification, role badges, auto-scroll, and a synchronized countdown timer with color transitions.

Purpose: This plan creates all user-facing components for the meeting-day experience. It wires the hooks and server actions from Plan 01 into a mobile-first chat interface that participants will use during the actual meeting.

Output: Station selector on dashboard, station chat page at `/dashboard/station/[sessionId]`, 7 new components in `src/components/station/`.
</objective>

<execution_context>
@/Users/mariusvalle-olsen/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mariusvalle-olsen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-station-chat-and-timer/03-RESEARCH.md
@.planning/phases/03-station-chat-and-timer/03-01-SUMMARY.md
@src/app/dashboard/page.tsx
@src/app/dashboard/layout.tsx
@src/components/ui/Badge.tsx
@src/components/ui/Button.tsx
@src/lib/actions/station.ts
@src/lib/hooks/useRealtimeChat.ts
@src/lib/hooks/useCountdownTimer.ts
@src/lib/hooks/useAutoScroll.ts
@src/lib/supabase/server.ts
@src/lib/supabase/client.ts
@src/app/globals.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Station selector on participant dashboard</name>
  <files>
    src/components/station/StationCard.tsx
    src/components/station/StationSelector.tsx
    src/app/dashboard/page.tsx
  </files>
  <action>
Create `src/components/station/` directory.

**`StationCard.tsx`** — Station card component:
- Props: `{ station: { id, number, title, description }, status: 'available' | 'active' | 'completed', onOpen: () => void, disabled: boolean }`
- Displays: station number, title, and a status indicator
- Status styles:
  - `available`: border-teal-primary/20, "Tilgjengelig" label in teal, card is tappable
  - `active`: border-coral/50 bg-coral/5, "Aktiv" label in coral, card is tappable (navigates to chat)
  - `completed`: border-text-muted/20 bg-text-muted/5, "Fullfort" label, card appears dimmed
- Card uses rounded-xl, p-4, mobile-optimized touch target (min-h-[80px])
- When `disabled` is true (another station is active), available stations show as greyed out and untappable
- Uses `<button>` element for accessibility (not div with onClick)
- No `"use client"` needed -- this is a presentational component rendered by StationSelector

**`StationSelector.tsx`** — Client component with station grid:
- `"use client"` directive
- Props: `{ stations: Array<{ id, number, title, description }>, sessions: Array<{ station_id, id, status, end_timestamp }>, groupId: string }`
- Maps stations to StationCards, looking up each station's session status from the sessions array
- If a station has no session, its status is `'available'`
- Computes `hasActiveStation` (any session with status='active') to disable other available stations
- On card tap for available station:
  - Calls `openStation(stationId)` server action (import from `@/lib/actions/station`)
  - On success: `router.push(\`/dashboard/station/\${result.sessionId}\`)` (using `useRouter` from `next/navigation`)
  - On error: show error in a toast-like element (simple state-based div, no library needed)
  - Shows loading state on the tapped card while action is in progress
- On card tap for active station:
  - Navigate directly to `/dashboard/station/${session.id}` (no server action needed, session already exists)
- Grid layout: `grid grid-cols-2 gap-3` on mobile (2 columns), `md:grid-cols-3` on desktop (3 columns)
- Completed stations are not tappable

**Update `src/app/dashboard/page.tsx`:**
- This is a Server Component. Add data fetching for stations and station_sessions.
- After the existing group query, add:
  ```typescript
  // Fetch all 6 stations
  const { data: stations } = await supabase
    .from('stations')
    .select('id, number, title, description')
    .order('number')

  // Fetch station sessions for user's group (if they have a group)
  let sessions: Array<{ station_id: string, id: string, status: string, end_timestamp: string | null }> = []
  if (group?.id) {
    const { data } = await supabase
      .from('station_sessions')
      .select('station_id, id, status, end_timestamp')
      .eq('group_id', group.id)
    sessions = data || []
  }
  ```
- Replace the placeholder text ("Stasjoner og gruppechat blir tilgjengelig...") with the `<StationSelector>` component when groups are locked:
  ```tsx
  {isGroupLocked && group && stations && (
    <StationSelector
      stations={stations}
      sessions={sessions}
      groupId={group.id}
    />
  )}
  ```
- Keep the existing "Du er ikke tildelt en gruppe enna" message for users without a group
- Keep the existing group card showing group name
- Keep the logout button at the bottom
  </action>
  <verify>
1. Run `npm run build` -- should compile with zero errors
2. Verify StationCard.tsx and StationSelector.tsx exist in src/components/station/
3. Verify dashboard page.tsx imports and renders StationSelector
  </verify>
  <done>
Dashboard shows 6 station cards in a 2-column grid when groups are locked. Each card shows station name and status (available/active/completed). Tapping available station calls openStation and navigates to chat. Tapping active station navigates directly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Station chat page with message list, input, timer, and full wiring</name>
  <files>
    src/app/dashboard/station/[sessionId]/page.tsx
    src/components/station/StationHeader.tsx
    src/components/station/ChatRoom.tsx
    src/components/station/MessageList.tsx
    src/components/station/MessageBubble.tsx
    src/components/station/ChatInput.tsx
    src/components/station/CountdownTimer.tsx
  </files>
  <action>
Create the route directory `src/app/dashboard/station/[sessionId]/`.

**`page.tsx`** — Server Component shell:
- Fetch the current user via `getUser()`, redirect to /login if not authenticated
- Fetch user profile (full_name, role) from profiles table
- Fetch the station session by `params.sessionId` from station_sessions table, joined with station data:
  ```typescript
  const { data: session } = await supabase
    .from('station_sessions')
    .select('id, status, end_timestamp, station:stations(id, number, title, description, questions, tip)')
    .eq('id', params.sessionId)
    .single()
  ```
- If session not found or user is not in the group (check via group_members), redirect to /dashboard
- Fetch initial messages via `loadMessages(params.sessionId)` from station server actions
- Render `<ChatRoom>` passing: sessionId, userId, userFullName, userRole, endTimestamp, stationTitle, stationQuestions, stationTip, initialMessages

**`StationHeader.tsx`** — Header bar (client component):
- `"use client"` directive
- Props: `{ stationTitle: string, stationNumber: number, endTimestamp: string | null }`
- Fixed at top of chat page, flex row with:
  - Back button (left arrow icon) linking to /dashboard via `router.push('/dashboard')`
  - Station title and number in center
  - `<CountdownTimer endTimestamp={endTimestamp} />` on the right
- Background: `bg-teal-primary`, text: `text-warm-white`
- Height: h-14 with px-4

**`ChatRoom.tsx`** — Main chat container (client component, THE wiring hub):
- `"use client"` directive
- Props: `{ sessionId, userId, userFullName, userRole, endTimestamp, stationTitle, stationNumber, stationQuestions, stationTip, initialMessages }`
- Wires ALL three hooks from Plan 01:
  1. `const { messages, setMessages, sendBroadcast } = useRealtimeChat(sessionId, userId)`
  2. `const timer = useCountdownTimer(endTimestamp)`
  3. `const { containerRef, sentinelRef, scrollToBottom } = useAutoScroll([messages])`
- On mount, merge `initialMessages` into the messages state (call `setMessages(initialMessages)`)
- Defines `handleSend(content: string)` that:
  1. Creates optimistic message: `{ id: crypto.randomUUID(), userId, fullName: userFullName, role: userRole, content, createdAt: new Date().toISOString() }`
  2. Sends via Broadcast: `sendBroadcast(optimisticMessage)`
  3. Persists via server action: `sendMessage({ id: optimisticMessage.id, sessionId, content })` (fire-and-forget, errors logged)
- Layout: flex flex-col h-dvh
  - `<StationHeader>` at top (passing stationTitle, stationNumber, endTimestamp)
  - Scrollable message area in the middle (flex-1 overflow-y-auto) with `ref={containerRef}`
    - Optional: show station questions/tip in a card at the top of the message list as context
    - `<MessageList>` rendering all messages
    - Sentinel div `<div ref={sentinelRef} />` at the bottom
  - `<ChatInput onSend={handleSend} />` at bottom (sticky)

**`MessageList.tsx`** — Scrollable message list:
- Props: `{ messages: ChatMessage[], currentUserId: string }`
- Maps over messages, rendering `<MessageBubble>` for each
- Passes `isOwn={msg.userId === currentUserId}` to each bubble
- If no messages, shows a subtle "Ingen meldinger enna" empty state

**`MessageBubble.tsx`** — Single message display:
- Props: `{ fullName, role, content, createdAt, isOwn }`
- Follow the research pattern exactly:
  - Own messages: `ml-auto items-end`, background `bg-teal-primary text-warm-white rounded-br-sm`
  - Others: `items-start`, background `bg-warm-white border border-teal-primary/10 text-text-primary rounded-bl-sm`
  - Max width: `max-w-[80%]`
  - Shows sender name, role badge (using existing Badge component with `variant={role}`), and formatted time (HH:MM in nb-NO locale)
  - Norwegian role labels: `role === 'youth' ? 'Ungdom' : 'Forelder'`
  - Content with `whitespace-pre-wrap break-words`

**`ChatInput.tsx`** — Message input form:
- `"use client"` directive
- Props: `{ onSend: (content: string) => void, disabled?: boolean }`
- Follow the research pattern:
  - Controlled input with `useState('')`
  - Form with `onSubmit` that trims and sends
  - Enter key sends (without Shift), Shift+Enter for newline (but using `<input>` not `<textarea>` for simplicity -- single line)
  - Placeholder: "Skriv en kommentar..."
  - maxLength: 2000
  - Send button with paper plane SVG icon, circular teal background
  - Disabled state when message is empty
- Layout: flex row with gap-2, padding p-3, border-t at top, bg-warm-white

**`CountdownTimer.tsx`** — Timer display component:
- Props: `{ endTimestamp: string | null }`
- Calls `useCountdownTimer(endTimestamp)` hook
- Color classes mapping:
  - `white` -> `text-warm-white` (visible on teal header background)
  - `yellow` -> `text-yellow-300` (visible on teal)
  - `red` -> `text-red-400 animate-pulse` (urgent, pulsing)
- Font: `font-mono text-sm font-bold`
- Shows `display` value from the hook (either "MM:SS" or "Tiden er ute!")

All components use `"use client"` only where they need interactivity (ChatRoom, StationSelector, StationHeader, ChatInput, CountdownTimer). MessageBubble and MessageList can be non-client if they don't use hooks.

Mobile-first layout: the entire chat page uses `h-dvh` (NOT h-screen) for proper mobile viewport handling. The chat input should stay above the mobile keyboard.
  </action>
  <verify>
1. Run `npm run build` -- should compile with zero errors
2. Verify all 7 files exist:
   - src/app/dashboard/station/[sessionId]/page.tsx
   - src/components/station/StationHeader.tsx
   - src/components/station/ChatRoom.tsx
   - src/components/station/MessageList.tsx
   - src/components/station/MessageBubble.tsx
   - src/components/station/ChatInput.tsx
   - src/components/station/CountdownTimer.tsx
3. Verify ChatRoom imports and uses all 3 hooks from Plan 01
4. Verify MessageBubble uses Badge component for role display
  </verify>
  <done>
Complete chat page at /dashboard/station/[sessionId] with: StationHeader (back button, title, timer), scrollable MessageList with MessageBubbles (own vs others styling, role badges, timestamps), ChatInput with send-on-enter, CountdownTimer with white/yellow/red color transitions and "Tiden er ute!" display. All wired via ChatRoom to the 3 hooks from Plan 01.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` passes with zero errors
2. Dashboard renders 6 station cards in a grid when groups are locked
3. Station chat page exists at /dashboard/station/[sessionId]
4. ChatRoom wires useRealtimeChat, useCountdownTimer, and useAutoScroll hooks
5. MessageBubble differentiates own messages (right-aligned, teal) from others (left-aligned, white)
6. CountdownTimer shows MM:SS with color transitions (white >5min, yellow 1-5min, red <1min)
7. At 0:00, timer shows "Tiden er ute!" and chat input remains functional
8. All text is in Norwegian (bokmal)
</verification>

<success_criteria>
- All 10 files exist and project builds successfully
- Station selector shows 6 cards with correct status indicators
- Chat page has proper mobile-first layout with h-dvh
- Messages show sender name, role badge, timestamp, and content
- Own messages are visually distinct from others
- Timer changes color based on remaining time
- Auto-scroll works (new messages scroll into view unless user scrolled up)
</success_criteria>

<output>
After completion, create `.planning/phases/03-station-chat-and-timer/03-02-SUMMARY.md`
</output>
