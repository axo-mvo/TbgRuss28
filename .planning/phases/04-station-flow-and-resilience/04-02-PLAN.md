---
phase: 04-station-flow-and-resilience
plan: 02
type: execute
wave: 2
depends_on: [04-01]
files_modified:
  - src/components/station/StationCard.tsx
  - src/components/station/StationSelector.tsx
  - src/app/dashboard/station/[sessionId]/page.tsx
  - src/lib/hooks/useConnectionStatus.ts
  - src/components/station/ConnectionStatus.tsx
  - src/components/station/StationHeader.tsx
autonomous: true
requirements: [FLOW-03, FLOW-04]

must_haves:
  truths:
    - "Completed stations appear with 'Fullfort' badge on station selector and are tappable"
    - "Tapping a completed station opens the chat in read-only mode showing all past messages"
    - "A connection indicator appears in StationHeader when the connection is reconnecting or offline"
    - "The connection indicator is hidden when connected (clean UI)"
  artifacts:
    - path: "src/components/station/StationCard.tsx"
      provides: "Tappable completed station cards with 'Se samtale' secondary label"
    - path: "src/components/station/StationSelector.tsx"
      provides: "Navigation to completed station sessions"
    - path: "src/app/dashboard/station/[sessionId]/page.tsx"
      provides: "Read-only detection and readOnly prop pass-through to ChatRoom"
      contains: "readOnly"
    - path: "src/lib/hooks/useConnectionStatus.ts"
      provides: "Connection status hook combining onHeartbeat + navigator.onLine"
      exports: ["useConnectionStatus"]
    - path: "src/components/station/ConnectionStatus.tsx"
      provides: "Compact dot indicator for connection state"
    - path: "src/components/station/StationHeader.tsx"
      provides: "ConnectionStatus indicator in header"
  key_links:
    - from: "src/components/station/StationSelector.tsx"
      to: "/dashboard/station/[sessionId]"
      via: "router.push for completed stations"
      pattern: "router\\.push.*station/"
    - from: "src/app/dashboard/station/[sessionId]/page.tsx"
      to: "src/components/station/ChatRoom.tsx"
      via: "readOnly prop based on session.status"
      pattern: "readOnly.*completed"
    - from: "src/components/station/ConnectionStatus.tsx"
      to: "src/lib/hooks/useConnectionStatus.ts"
      via: "useConnectionStatus hook call"
      pattern: "useConnectionStatus"
    - from: "src/components/station/StationHeader.tsx"
      to: "src/components/station/ConnectionStatus.tsx"
      via: "ConnectionStatus component render"
      pattern: "<ConnectionStatus"
---

<objective>
Make completed stations tappable on the station selector for read-only viewing, and add a connection status indicator that shows reconnecting/offline state in the station header.

Purpose: Users need to review past discussions after a station is completed, and they need visibility into connection health during real-time chat.
Output: Tappable completed StationCards, read-only station page detection, useConnectionStatus hook, ConnectionStatus indicator component in StationHeader.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-station-flow-and-resilience/04-RESEARCH.md
@.planning/phases/04-station-flow-and-resilience/04-01-SUMMARY.md
@src/components/station/StationCard.tsx
@src/components/station/StationSelector.tsx
@src/app/dashboard/station/[sessionId]/page.tsx
@src/components/station/StationHeader.tsx
@src/lib/supabase/client.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Completed station navigation and read-only page detection</name>
  <files>src/components/station/StationCard.tsx, src/components/station/StationSelector.tsx, src/app/dashboard/station/[sessionId]/page.tsx</files>
  <action>
1. Modify `src/components/station/StationCard.tsx`:
   - Change `isTappable` logic: completed stations ARE now tappable. New logic: `const isTappable = !disabled || status === 'completed'`. Actually simpler: `const isTappable = status === 'completed' || (status !== 'completed' && !disabled)` which simplifies to `const isTappable = status === 'completed' || !disabled`.
   - Remove the `opacity-60` from completed status style. Replace with `opacity-75` for a subtler dimming that still looks tappable.
   - For completed status, add a secondary label below the "Fullfort" badge. Add a small "Se samtale" text under the station title when `status === 'completed'`: `{status === 'completed' && <p className="text-[10px] text-text-muted mt-0.5">Se samtale</p>}`.
   - Keep the `active:scale-[0.98]` press feedback for completed cards.

2. Modify `src/components/station/StationSelector.tsx`:
   - Update `handleOpen` to handle completed status. Add a case at the top: if `status === 'completed'`, get the sessionId and navigate to `/dashboard/station/${sessionId}`. This is the same navigation pattern as the active case.
   - The function already has `getSessionId(stationId)` helper, so this is a 3-line addition.

3. Modify `src/app/dashboard/station/[sessionId]/page.tsx`:
   - After fetching the session, determine readOnly: `const isReadOnly = session.status === 'completed'`.
   - Pass `readOnly={isReadOnly}` to ChatRoom component.
   - When readOnly, pass `endTimestamp={null}` to ChatRoom (no timer needed for completed stations).
   - Keep the existing auth check, profile fetch, and membership verification -- all still needed for read-only access.
   - The rest of the page stays the same: loadMessages works for completed sessions, formattedMessages mapping is unchanged.
  </action>
  <verify>Run `npx next build` -- zero errors. Verify StationCard renders completed stations as tappable with "Se samtale" label. Verify page.tsx passes readOnly prop to ChatRoom.</verify>
  <done>Completed stations are tappable on the station selector, navigating to the station page which detects completed status and renders ChatRoom in read-only mode with message history.</done>
</task>

<task type="auto">
  <name>Task 2: Connection status hook and indicator component</name>
  <files>src/lib/hooks/useConnectionStatus.ts, src/components/station/ConnectionStatus.tsx, src/components/station/StationHeader.tsx</files>
  <action>
1. Create `src/lib/hooks/useConnectionStatus.ts`:
   - `'use client'` directive.
   - Import `useState`, `useEffect` from 'react'.
   - Import `createClient` from '@/lib/supabase/client'.
   - Export type `ConnectionStatus = 'connected' | 'reconnecting' | 'offline'`.
   - Export function `useConnectionStatus(): ConnectionStatus`.
   - Initialize state with a function: `() => typeof navigator !== 'undefined' && !navigator.onLine ? 'offline' : 'connected'`. This avoids SSR issues and defaults to 'connected' to prevent flash of 'reconnecting' on load (per research pitfall 5).
   - In useEffect:
     a. Get supabase client: `const supabase = createClient()` (singleton, per research pitfall 6).
     b. Add `window.addEventListener('online', handleOnline)` -- set status to 'reconnecting' (not 'connected' -- wait for heartbeat confirmation).
     c. Add `window.addEventListener('offline', handleOffline)` -- set status to 'offline'.
     d. Add `supabase.realtime.onHeartbeat((heartbeatStatus: string) => { ... })`:
        - 'ok' -> setStatus('connected')
        - 'timeout' or 'error' -> setStatus('reconnecting')
        - 'disconnected' -> setStatus('offline')
        - 'sent' -> ignore (just means heartbeat was sent, waiting for reply)
     e. Cleanup: remove both event listeners. Note: `onHeartbeat` does not have a cleanup method -- it persists on the singleton client, which is fine for the app lifecycle.

2. Create `src/components/station/ConnectionStatus.tsx`:
   - `'use client'` directive.
   - Import `useConnectionStatus` from '@/lib/hooks/useConnectionStatus'.
   - Define statusConfig object with Norwegian labels:
     - connected: `{ color: 'bg-green-500', label: '' }` (hidden when connected)
     - reconnecting: `{ color: 'bg-yellow-500 animate-pulse', label: 'Kobler til...' }`
     - offline: `{ color: 'bg-red-500', label: 'Frakoblet' }`
   - Return `null` when status is 'connected' (clean UI, hidden when healthy).
   - Otherwise render: a flex container with a 2x2 rounded dot and small label text. Use `text-[10px] text-warm-white/70` for the label to blend with the teal header.

3. Modify `src/components/station/StationHeader.tsx`:
   - Import `ConnectionStatus` from './ConnectionStatus'.
   - Add the `<ConnectionStatus />` component in the header, positioned BETWEEN the station title area and the timer/end-button area. Place it right after the title `<div>` and before the timer `<div>`.
   - Only render ConnectionStatus when NOT readOnly (no need for connection indicator when reviewing completed discussions).
  </action>
  <verify>Run `npx next build` -- zero errors, zero warnings. Verify useConnectionStatus.ts exports useConnectionStatus. Verify ConnectionStatus.tsx returns null when connected. Verify StationHeader renders ConnectionStatus between title and timer.</verify>
  <done>Connection status indicator shows "Kobler til..." (yellow pulsing dot) when reconnecting and "Frakoblet" (red dot) when offline. Hidden when connected for clean UI. Rendered in StationHeader for all active station views.</done>
</task>

</tasks>

<verification>
- `npx next build` passes with zero errors and zero warnings
- StationCard allows tapping completed stations (no longer blocked by `isTappable` guard)
- StationSelector navigates to `/dashboard/station/{sessionId}` for completed stations
- Station page passes `readOnly={true}` to ChatRoom when session status is 'completed'
- useConnectionStatus hook exists and combines onHeartbeat + navigator.onLine
- ConnectionStatus component renders null when connected, dot+label when not
- StationHeader includes ConnectionStatus between title and timer (only when not readOnly)
</verification>

<success_criteria>
1. Completed stations are tappable on the station selector and open in read-only mode
2. Connection status indicator compiles and renders conditionally based on connection health
3. Build passes with zero errors and zero warnings
</success_criteria>

<output>
After completion, create `.planning/phases/04-station-flow-and-resilience/04-02-SUMMARY.md`
</output>
