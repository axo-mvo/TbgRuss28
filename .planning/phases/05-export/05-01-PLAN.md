---
phase: 05-export
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/export/build-markdown.ts
  - src/app/api/export/route.ts
  - src/app/admin/page.tsx
autonomous: true
requirements:
  - EXPT-01
  - EXPT-02

must_haves:
  truths:
    - "Admin can click an export button on the admin page and receive a Markdown file download"
    - "The exported Markdown is organized by station (1-6), then by group within each station"
    - "Each message in the export includes timestamp, author name, author role, and content"
    - "Non-admin users cannot access the export endpoint (401/403)"
    - "Empty export (no messages) produces a valid Markdown file with a 'no conversations' message"
  artifacts:
    - path: "src/lib/export/build-markdown.ts"
      provides: "Pure function converting structured message data to Markdown string"
      exports: ["buildExportMarkdown"]
    - path: "src/app/api/export/route.ts"
      provides: "GET Route Handler returning Markdown file download with admin auth"
      exports: ["GET"]
    - path: "src/app/admin/page.tsx"
      provides: "Admin hub page with export button/link"
      contains: "/api/export"
  key_links:
    - from: "src/app/admin/page.tsx"
      to: "/api/export"
      via: "anchor tag with href"
      pattern: "href.*api/export"
    - from: "src/app/api/export/route.ts"
      to: "src/lib/export/build-markdown.ts"
      via: "import and function call"
      pattern: "buildExportMarkdown"
    - from: "src/app/api/export/route.ts"
      to: "supabase admin client"
      via: "createAdminClient() for message query"
      pattern: "createAdminClient"
---

<objective>
Implement admin Markdown export of all meeting conversations, organized by station then group, with timestamps and author info. A single GET Route Handler verifies admin auth, queries all messages with joins, builds a Markdown string via a pure helper function, and returns it as a downloadable file. The admin page gets an export button linking to the endpoint.

Purpose: Allow the admin to download all discussion data for downstream processing after the meeting.
Output: Route Handler at /api/export, Markdown builder utility, and export link on admin page.
</objective>

<execution_context>
@/Users/mariusvalle-olsen/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mariusvalle-olsen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-export/05-RESEARCH.md

@src/lib/supabase/admin.ts
@src/lib/supabase/server.ts
@src/lib/actions/admin.ts
@src/lib/actions/station.ts
@src/app/admin/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Markdown builder and export Route Handler</name>
  <files>src/lib/export/build-markdown.ts, src/app/api/export/route.ts</files>
  <action>
    **1. Create `src/lib/export/build-markdown.ts`:**

    Define an `ExportMessage` interface:
    ```typescript
    interface ExportMessage {
      content: string
      createdAt: string
      authorName: string
      authorRole: string
      stationNumber: number
      stationTitle: string
      groupName: string
    }
    ```

    Implement a `groupBy<T>` helper (inline, not exported -- simple Record grouping by key function).

    Export `buildExportMarkdown(messages: ExportMessage[]): string`:
    - If messages array is empty, return a Markdown document with header "Fellesmote - Eksport" and body "Ingen samtaler funnet." (handles empty export pitfall from research).
    - Start with `# Fellesmote - Eksport\n\n` and an export timestamp line using `new Date().toLocaleString('nb-NO')`.
    - Add `---` separator.
    - Group messages by `stationNumber` (sorted ascending by station number).
    - For each station, emit `# Stasjon {number}: {title}`.
    - Within each station, group by `groupName` (sorted alphabetically).
    - For each group, emit `## {groupName}`.
    - For each message, emit: `**{authorName}** ({norwegianRole}) - {HH:MM}` followed by the content on the next line, then a blank line.
    - Map roles: `parent` -> `forelder`, `youth` -> `ungdom`, `admin` -> `admin`.
    - Format time with `toLocaleTimeString('nb-NO', { hour: '2-digit', minute: '2-digit' })`.
    - After each station's messages, add a `---` separator.

    **2. Create `src/app/api/export/route.ts`:**

    Set `export const dynamic = 'force-dynamic'` to prevent caching.

    Export a `GET` handler:
    - **Auth check:** Use `createClient()` from `@/lib/supabase/server` to get the user via `supabase.auth.getUser()`. If no user, return `new Response('Ikke autentisert', { status: 401 })`. Query profile role; if not admin, return `new Response('Ikke autorisert', { status: 403 })`. This mirrors the `verifyAdmin()` pattern from `src/lib/actions/admin.ts` but returns HTTP responses instead of objects.
    - **Data query:** Use `createAdminClient()` from `@/lib/supabase/admin` to query messages with nested joins:
      ```
      .from('messages')
      .select(`
        id, content, created_at,
        profiles:user_id ( full_name, role ),
        station_sessions:session_id (
          stations:station_id ( number, title ),
          groups:group_id ( name )
        )
      `)
      .order('created_at', { ascending: true })
      ```
    - If query error, return `new Response('Eksport feilet', { status: 500 })`.
    - **Transform data:** Map query results to `ExportMessage[]`. Handle PostgREST join shape defensively: `profiles` and nested objects may be array or object (use `Array.isArray(x) ? x[0] : x` pattern, same as `loadMessages` in station.ts).
    - **Build Markdown:** Call `buildExportMarkdown(messages)`.
    - **Return download:** Return `new Response(markdown, { headers: { 'Content-Type': 'text/markdown; charset=utf-8', 'Content-Disposition': 'attachment; filename="eksport-fellesmote.md"' } })`.
  </action>
  <verify>
    Run `npx tsc --noEmit` -- no type errors in new files.
    Run `npm run build` -- build succeeds with no errors.
  </verify>
  <done>
    Route Handler at /api/export exists, compiles, and returns a Markdown file download with correct Content-Type and Content-Disposition headers. Markdown builder correctly groups by station then group with timestamps and Norwegian role labels. Empty message set produces valid "no conversations" Markdown. Non-admin requests receive 401/403.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add export button to admin page</name>
  <files>src/app/admin/page.tsx</files>
  <action>
    Modify the admin hub page at `src/app/admin/page.tsx` to add a third card-style link for the export feature. Add it after the existing "Grupper" card and before the logout button.

    Use an `<a>` tag (not `<Link>`) with `href="/api/export"` and `download` attribute, styled identically to the existing Brukere and Grupper cards:
    ```tsx
    <a
      href="/api/export"
      download
      className="block rounded-xl border border-gray-200 bg-white p-5 shadow-sm
        hover:border-teal-primary hover:shadow-md transition-all"
    >
      <div className="flex items-center gap-3 mb-2">
        <svg className="h-6 w-6 text-teal-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}
            d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
        </svg>
        <h2 className="text-lg font-semibold text-text-primary">Eksporter samtaler</h2>
      </div>
      <p className="text-sm text-text-muted">
        Last ned alle diskusjoner som Markdown-fil
      </p>
    </a>
    ```

    Use an `<a>` tag because this is a file download (not a client navigation). The `download` attribute signals the browser to download rather than navigate. The SVG icon represents a document download (arrow pointing down into a document).
  </action>
  <verify>
    Run `npm run build` -- build succeeds.
    Visually confirm: the admin page at /admin now shows three cards: Brukere, Grupper, Eksporter samtaler.
  </verify>
  <done>
    Admin page displays an "Eksporter samtaler" card that links to /api/export with download attribute. Card style matches existing admin hub cards (same border, shadow, hover, icon pattern). Norwegian text throughout.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` succeeds with no errors
2. TypeScript compilation (`npx tsc --noEmit`) passes
3. Route Handler exists at `src/app/api/export/route.ts` with GET export
4. Markdown builder exists at `src/lib/export/build-markdown.ts` with `buildExportMarkdown` export
5. Admin page at `src/app/admin/page.tsx` contains link to `/api/export`
</verification>

<success_criteria>
- Admin can click "Eksporter samtaler" on the admin page and receive a Markdown file download
- The Markdown file is organized: station headers (sorted by number), group sub-headers (sorted alphabetically), messages (sorted chronologically) with author name, role, and timestamp
- Empty export produces valid Markdown with "Ingen samtaler funnet" message
- Non-admin users receive 401 (unauthenticated) or 403 (wrong role)
- No new dependencies added to package.json
</success_criteria>

<output>
After completion, create `.planning/phases/05-export/05-01-SUMMARY.md`
</output>
