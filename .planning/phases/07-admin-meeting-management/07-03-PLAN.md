---
phase: 07-admin-meeting-management
plan: 03
type: execute
wave: 3
depends_on: ["07-01", "07-02"]
files_modified:
  - src/components/admin/MeetingTabs.tsx
  - src/components/admin/GroupBuilder.tsx
  - src/components/admin/MeetingLifecycleControls.tsx
  - src/components/admin/MeetingResultsTab.tsx
  - src/lib/actions/meeting.ts
  - src/lib/actions/admin.ts
  - src/app/api/export/route.ts
  - src/lib/export/build-markdown.ts
  - src/app/admin/meetings/[id]/page.tsx
autonomous: true
requirements: [MEET-04, SCOPE-01, SCOPE-04, SCOPE-05]

must_haves:
  truths:
    - "Admin can build groups for a specific meeting using the existing group builder inside the Grupper tab"
    - "Groups created in one meeting do not appear in another meeting"
    - "Admin can start a meeting (upcoming -> active) only when at least 1 station and 1 group exist"
    - "Admin can end a meeting (active -> completed), force-closing any active sessions"
    - "Export downloads a markdown file scoped to the selected meeting with meeting title and date in the header"
    - "Word cloud displays word frequencies from only the selected meeting's discussions"
    - "Completed meetings show all tabs in read-only mode"
  artifacts:
    - path: "src/components/admin/MeetingLifecycleControls.tsx"
      provides: "Start/End meeting buttons with prerequisite checks and confirmation dialogs"
    - path: "src/components/admin/MeetingResultsTab.tsx"
      provides: "Export button + WordCloud wrapper scoped to meeting"
    - path: "src/components/admin/GroupBuilder.tsx"
      provides: "Updated GroupBuilder accepting meetingId prop for scoped group operations"
    - path: "src/lib/actions/admin.ts"
      provides: "Updated group actions accepting meetingId parameter"
    - path: "src/lib/actions/meeting.ts"
      provides: "activateMeeting and completeMeeting lifecycle actions"
    - path: "src/app/api/export/route.ts"
      provides: "Meeting-scoped export route accepting meetingId query param"
    - path: "src/lib/export/build-markdown.ts"
      provides: "Updated buildExportMarkdown accepting meeting title and date for header"
  key_links:
    - from: "src/components/admin/GroupBuilder.tsx"
      to: "src/lib/actions/admin.ts"
      via: "createGroup(meetingId), saveGroupMembers, toggleGroupsLock with meeting scope"
      pattern: "createGroup.*meetingId"
    - from: "src/components/admin/MeetingLifecycleControls.tsx"
      to: "src/lib/actions/meeting.ts"
      via: "activateMeeting, completeMeeting server actions"
      pattern: "activateMeeting|completeMeeting"
    - from: "src/components/admin/MeetingResultsTab.tsx"
      to: "/api/export?meetingId="
      via: "Download link with meetingId query parameter"
      pattern: "api/export.*meetingId"
    - from: "src/app/api/export/route.ts"
      to: "meetings -> stations -> station_sessions -> messages"
      via: "Meeting-scoped message query with FK chain filter"
      pattern: "meetingId|meeting_id"
---

<objective>
Wire meeting-scoped groups (Grupper tab), lifecycle controls (start/end meeting), and results (export + word cloud) into the meeting detail page.

Purpose: Complete the meeting management feature: admin can build per-meeting groups, progress meetings through their lifecycle, and view meeting-scoped results. This is the final plan — after it, Phase 7 is done.
Output: Working Grupper tab with scoped group builder, lifecycle control buttons, meeting-scoped export and word cloud in Resultat tab.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-admin-meeting-management/07-RESEARCH.md
@.planning/phases/07-admin-meeting-management/07-CONTEXT.md
@.planning/phases/07-admin-meeting-management/07-01-SUMMARY.md
@.planning/phases/07-admin-meeting-management/07-02-SUMMARY.md

@src/components/admin/GroupBuilder.tsx
@src/components/admin/WordCloud.tsx
@src/components/admin/MeetingTabs.tsx
@src/lib/actions/admin.ts
@src/lib/actions/meeting.ts
@src/app/api/export/route.ts
@src/lib/export/build-markdown.ts
@src/app/admin/meetings/[id]/page.tsx
@src/app/admin/groups/page.tsx
@src/app/admin/wordcloud/page.tsx
@src/components/ui/Dialog.tsx
@src/components/ui/Badge.tsx

<interfaces>
<!-- Key types and contracts from existing codebase. -->

From src/components/admin/GroupBuilder.tsx (current props — will be modified):
```typescript
interface GroupBuilderProps {
  initialGroups: Record<string, string[]>  // groupId -> userIds
  users: UserData[]
  parentChildLinks: { parent_id: string; youth_id: string }[]
  groupNames: Record<string, string>
  initialLocked: boolean
}
```

From src/components/admin/WordCloud.tsx:
```typescript
export interface WordCloudMessage {
  content: string; groupId: string; groupName: string;
  stationId: string; stationNumber: number; stationTitle: string;
}
interface WordCloudProps {
  messages: WordCloudMessage[]; groups: { id: string; name: string }[];
  stations: { id: string; number: number; title: string }[];
}
```

From src/lib/actions/admin.ts (group actions to modify):
```typescript
export async function createGroup(): Promise<{ error?: string; group?: { id: string; name: string } }>
export async function deleteGroup(groupId: string): Promise<{ error?: string }>
export async function saveGroupMembers(assignments: { groupId: string; userIds: string[] }[]): Promise<{ error?: string }>
export async function toggleGroupsLock(locked: boolean): Promise<{ error?: string }>
```

From src/lib/export/build-markdown.ts:
```typescript
export interface ExportMessage {
  content: string; stationNumber: number; stationTitle: string; groupName: string;
}
export function buildExportMarkdown(messages: ExportMessage[]): string
```

Meeting lifecycle states: 'upcoming' -> 'active' -> 'completed' (one-way transitions)
station_sessions.status: 'active' | 'completed'
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Meeting-scoped group actions and lifecycle server actions</name>
  <files>src/lib/actions/admin.ts, src/lib/actions/meeting.ts</files>
  <action>
**Modify `src/lib/actions/admin.ts`** — make group actions meeting-scoped:

1. **`createGroup(meetingId?: string)`** — add optional meetingId parameter:
   - If meetingId provided, check available names scoped to this meeting: `admin.from('groups').select('name').eq('meeting_id', meetingId)` (not all groups globally)
   - Insert with meeting_id: `admin.from('groups').insert({ name: randomName, meeting_id: meetingId })`
   - If meetingId not provided, fall back to existing behavior (for backward compat, though the old groups page will be removed)
   - `revalidatePath(`/admin/meetings/${meetingId}`)` instead of `/admin/groups`

2. **`deleteGroup(groupId: string, meetingId?: string)`** — add optional meetingId parameter:
   - Existing logic unchanged (delete by groupId)
   - `revalidatePath(`/admin/meetings/${meetingId}`)` if meetingId provided, else `/admin/groups`

3. **`saveGroupMembers(assignments, meetingId?: string)`** — add optional meetingId parameter:
   - Existing logic unchanged (clear + re-insert with parent-child check)
   - `revalidatePath(`/admin/meetings/${meetingId}`)` if meetingId provided, else `/admin/groups`

4. **`toggleGroupsLock(locked: boolean, meetingId?: string)`** — add optional meetingId parameter:
   - If meetingId provided: only lock/unlock groups for this meeting: `admin.from('groups').update({ locked }).eq('meeting_id', meetingId)`
   - If not provided: existing behavior (all groups)
   - `revalidatePath(`/admin/meetings/${meetingId}`)` if meetingId provided

**IMPORTANT:** Keep all existing function signatures backward-compatible by making meetingId optional. The old `/admin/groups` page still exists (though it will become unused). This prevents breaking existing code before the meeting detail Grupper tab is fully wired.

**Add lifecycle actions to `src/lib/actions/meeting.ts`:**

5. **`activateMeeting(meetingId: string)`** → `Promise<{ error?: string }>`:
   - verifyAdmin()
   - Fetch meeting, verify status is 'upcoming'
   - Check prerequisites:
     - `admin.from('stations').select('*', { count: 'exact', head: true }).eq('meeting_id', meetingId)` — need >= 1
     - `admin.from('groups').select('*', { count: 'exact', head: true }).eq('meeting_id', meetingId)` — need >= 1
   - If prerequisites not met: return specific error ("Minst 1 stasjon kreves" or "Minst 1 gruppe kreves")
   - Update: `admin.from('meetings').update({ status: 'active', updated_at: new Date().toISOString() }).eq('id', meetingId)`
   - `revalidatePath('/admin/meetings')`, `revalidatePath('/dashboard')`

6. **`completeMeeting(meetingId: string)`** → `Promise<{ error?: string; forceClosedCount?: number }>`:
   - verifyAdmin()
   - Fetch meeting, verify status is 'active'
   - Find active station_sessions for this meeting: query `station_sessions` with status='active' joined through stations (station_sessions.station_id -> stations.meeting_id) OR through groups (station_sessions.group_id -> groups.meeting_id). Use the groups path: `admin.from('station_sessions').select('id, groups!inner(meeting_id)').eq('status', 'active').eq('groups.meeting_id', meetingId)`
   - Force-close all found sessions: `admin.from('station_sessions').update({ status: 'completed', completed_at: new Date().toISOString() }).in('id', ids)`
   - Update meeting: `admin.from('meetings').update({ status: 'completed', updated_at: new Date().toISOString() }).eq('id', meetingId)`
   - `revalidatePath('/admin/meetings')`, `revalidatePath('/dashboard')`
   - Return `{ forceClosedCount }`

7. **`getActiveSessionCount(meetingId: string)`** → `Promise<number>`:
   - verifyAdmin()
   - Count active sessions for this meeting (same query as in completeMeeting but just count)
   - Return count — used by lifecycle controls to show warning before completing
  </action>
  <verify>
    <automated>cd /Users/mariusvalle-olsen/Github/TbgRuss28 && npx tsc --noEmit --pretty 2>&1 | head -30</automated>
  </verify>
  <done>
- Group actions accept optional meetingId parameter and scope queries accordingly
- activateMeeting checks prerequisites (>= 1 station, >= 1 group) before transitioning to active
- completeMeeting force-closes active sessions and transitions to completed
- getActiveSessionCount returns count for lifecycle warning dialog
- All actions maintain backward compatibility
- TypeScript compiles cleanly
  </done>
</task>

<task type="auto">
  <name>Task 2: Grupper tab, lifecycle controls, Resultat tab, and meeting-scoped export</name>
  <files>src/components/admin/MeetingTabs.tsx, src/components/admin/GroupBuilder.tsx, src/components/admin/MeetingLifecycleControls.tsx, src/components/admin/MeetingResultsTab.tsx, src/app/api/export/route.ts, src/lib/export/build-markdown.ts, src/app/admin/meetings/[id]/page.tsx</files>
  <action>
**Modify `src/components/admin/GroupBuilder.tsx`** — add meetingId prop:
- Add `meetingId?: string` to GroupBuilderProps interface
- Pass meetingId to `createGroup(meetingId)`, `deleteGroup(groupId, meetingId)`, `saveGroupMembers(assignments, meetingId)`, `toggleGroupsLock(locked, meetingId)` calls
- No other changes needed — the component logic (DnD, parent-child checks, UI) stays identical
- Add `readOnly?: boolean` prop — when true, hide create/save/lock buttons and disable all interactions (for completed meetings)

**Create `src/components/admin/MeetingLifecycleControls.tsx`** — `'use client'`:
- Props: `meeting: Meeting, stationCount: number, groupCount: number`
- State: `showStartDialog`, `showEndDialog`, `loading`, `error`, `activeSessionCount`
- Display depends on meeting.status:
  - **upcoming**: Show "Start møte" button (primary variant). On click, open confirmation Dialog. Prerequisites shown: "X stasjoner, X grupper klar". Button disabled if stationCount < 1 or groupCount < 1 — show inline text "Legg til minst 1 stasjon og 1 gruppe for å starte møtet". On confirm: call `activateMeeting(meeting.id)`, then `router.refresh()`.
  - **active**: Show "Avslutt møte" button (danger variant). On click, first call `getActiveSessionCount(meeting.id)` to check for active sessions. If count > 0: show warning in Dialog: "X grupper er fortsatt aktive. Avslutt likevel?". If count === 0: show simpler confirmation. On confirm: call `completeMeeting(meeting.id)`, then `router.refresh()`.
  - **completed**: Show Badge "Møtet er avsluttet" (no action buttons)
- Use existing Dialog component for confirmations
- Error display below buttons

**Create `src/components/admin/MeetingResultsTab.tsx`** — `'use client'`:
- Props: `meeting: Meeting, messages: WordCloudMessage[], groups: { id: string; name: string }[], stations: { id: string; number: number; title: string }[]`
- Layout:
  - "Eksporter samtaler" section: download link `<a href={`/api/export?meetingId=${meeting.id}`} download>` styled as Button (primary variant). Text: "Last ned Markdown-eksport"
  - Divider
  - "Ordsky" section: render existing `<WordCloud messages={messages} groups={groups} stations={stations} />` component — data already filtered by meeting
- If no messages: show EmptyState "Ingen samtaler ennå for dette møtet"

**Modify `src/app/api/export/route.ts`** — add meetingId filter:
- Accept optional `meetingId` query param: `const meetingId = new URL(request.url).searchParams.get('meetingId')`
- If meetingId provided:
  - Fetch meeting info: `admin.from('meetings').select('title, date, venue').eq('id', meetingId).single()`
  - Fetch messages filtered by meeting: query messages joined through station_sessions -> stations, then filter where `stations.meeting_id = meetingId`. Implementation: fetch all messages with station join (existing query), then filter in JS: `data.filter(msg => msg.station_sessions?.stations?.meeting_id === meetingId)` — same defensive array handling as existing code
  - Pass meeting title and date to buildExportMarkdown
- If no meetingId: keep existing behavior (all messages) for backward compat
- Update Content-Disposition filename to include meeting title: `eksport-${meeting.title.toLowerCase().replace(/\s+/g, '-')}.md`

**Modify `src/lib/export/build-markdown.ts`** — add meeting header:
- Update `buildExportMarkdown` signature: `(messages: ExportMessage[], meetingInfo?: { title: string; date: string | null; venue: string | null }) => string`
- If meetingInfo provided: header becomes `# ${meetingInfo.title} - Eksport` with date and venue below
- If not provided: keep existing header "Fellesmøte - Eksport" (backward compat)

**Update `src/app/admin/meetings/[id]/page.tsx`** — fetch all data for tabs:
- Add parallel queries for Grupper tab data (same as current `/admin/groups/page.tsx`):
  - users: `supabase.from('profiles').select('id, full_name, role, attending').in('role', ['youth', 'parent', 'admin']).order('full_name')`
  - groupsData: `supabase.from('groups').select('id, name, locked, group_members(user_id)').eq('meeting_id', id).order('created_at')`
  - parentChildLinks: `supabase.from('parent_youth_links').select('parent_id, youth_id')`
- Add parallel queries for Resultat tab data (same as current `/admin/wordcloud/page.tsx` but filtered by meeting):
  - messages: query messages joined through station_sessions -> stations, filter by meeting_id
  - meeting-scoped groups and stations for wordcloud filters
- Transform data same way as existing groups/page.tsx and wordcloud/page.tsx
- Pass all data to MeetingTabs

**Update `src/components/admin/MeetingTabs.tsx`** — wire all tabs:
- Expand props to receive all tab data: groups data (initialGroups, users, parentChildLinks, groupNames, groupsLocked), wordcloud data (messages, groups, stations for filters), stationCount, groupCount
- Replace Grupper tab placeholder with `<GroupBuilder meetingId={meeting.id} initialGroups={...} users={...} parentChildLinks={...} groupNames={...} initialLocked={...} readOnly={meeting.status === 'completed'} />`
- Replace Resultat tab placeholder with `<MeetingResultsTab meeting={meeting} messages={...} groups={...} stations={...} />`
- Add `<MeetingLifecycleControls meeting={meeting} stationCount={stationCount} groupCount={groupCount} />` above the tabs — visible on all tabs
  </action>
  <verify>
    <automated>cd /Users/mariusvalle-olsen/Github/TbgRuss28 && npx tsc --noEmit --pretty 2>&1 | head -30</automated>
  </verify>
  <done>
- Grupper tab shows the GroupBuilder component scoped to the current meeting
- Groups created in meeting A do not appear in meeting B
- Lifecycle controls: "Start møte" button visible for upcoming meetings (disabled until prerequisites met), "Avslutt møte" for active meetings with force-close warning
- Resultat tab shows export download button and WordCloud, both scoped to the meeting
- Export API accepts meetingId param and returns meeting-scoped markdown
- Completed meetings show all tabs in read-only mode
- TypeScript compiles cleanly
  </done>
</task>

</tasks>

<verification>
1. Navigate to upcoming meeting -> Grupper tab -> create groups, assign members -> groups appear only in this meeting
2. Try "Start møte" with 0 groups -> blocked. Add 1 group -> "Start møte" works (requires >= 1 station from Plan 02 + >= 1 group)
3. Meeting transitions to active status -> stations become read-only, groups become read-only
4. Navigate to Resultat tab -> "Last ned Markdown-eksport" downloads a meeting-scoped .md file
5. Word cloud shows only data from this meeting's discussions (initially empty for new meeting, shows data for the backfilled "Fellesmote #1")
6. "Avslutt møte" on active meeting -> confirmation with active session warning -> meeting transitions to completed
7. Completed meeting -> all tabs read-only, "Møtet er avsluttet" badge shown
8. Create a second meeting after completing the first -> groups are fresh (empty), not carried over
9. Export for different meetings produces different content
10. TypeScript compiles with no errors
</verification>

<success_criteria>
- Per-meeting group management: groups scoped by meeting_id, builder works inside Grupper tab
- Lifecycle control: upcoming -> active (with prerequisite check) -> completed (with force-close)
- Meeting-scoped export: downloads markdown for specific meeting with title/date header
- Meeting-scoped word cloud: shows frequencies for specific meeting only
- Read-only mode for completed meetings across all tabs
- All Norwegian labels, mobile-first, 44px touch targets
- Backward compatibility: old group actions still work if called without meetingId
</success_criteria>

<output>
After completion, create `.planning/phases/07-admin-meeting-management/07-03-SUMMARY.md`
</output>
