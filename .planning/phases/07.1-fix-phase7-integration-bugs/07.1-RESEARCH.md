# Phase 7.1: Fix Phase 7 Integration Bugs - Research

**Researched:** 2026-02-26
**Domain:** Supabase query builder behavior, Next.js route management, async error handling
**Confidence:** HIGH

## Summary

Phase 7.1 was created to address bugs found in the v1.1 milestone audit. However, deep investigation of the Supabase JS client source code (`@supabase/postgrest-js`) reveals that **two of the four identified issues are false positives**. The audit report claimed that `createGroup` and `toggleGroupsLock` had "Supabase query builder mutation bugs" where `.eq()` filters were discarded because the return value was not reassigned. This is incorrect: the Supabase `PostgrestFilterBuilder.eq()` method **mutates `this` in place** (appending to `this.url.searchParams`) and returns `this`. The code as written works correctly.

The two remaining issues are real: (1) `reorderStations()` is called without `await` in the `onDragEnd` handler, silently swallowing server errors; and (2) orphaned `/admin/groups` and `/admin/wordcloud` routes are accessible via direct URL but no longer linked from the admin hub, creating dead-end navigation.

**Primary recommendation:** Fix the unawaited `reorderStations` call, remove or redirect the orphaned routes, and skip the false-positive query builder "fixes" entirely.

<phase_requirements>
## Phase Requirements

| ID | Description | Research Support |
|----|-------------|-----------------|
| SCOPE-01 | Groups are created fresh per meeting via the existing group builder | **Already working correctly.** The `createGroup` name-availability check and `toggleGroupsLock` scope filter both use `.eq()` which mutates the query builder in place. Verified by reading `@supabase/postgrest-js` source and running a direct test. No code change needed for these functions. The remaining fixes (unawaited reorder, orphaned routes) are tech debt affecting reliability and UX. |
</phase_requirements>

## Standard Stack

### Core

No new libraries are needed for this phase. All fixes use the existing stack.

| Library | Version | Purpose | Status |
|---------|---------|---------|--------|
| `@supabase/supabase-js` | ^2.97.0 | Database queries, admin client | Already installed, no changes |
| `@supabase/postgrest-js` | (transitive) | Query builder used by supabase-js | Already installed, behavior verified |
| `@dnd-kit/react` | (installed) | Drag-and-drop for station reorder | Already installed, onDragEnd handler needs async fix |
| `next` | 15.x | App Router, routing, redirects | Already installed, next.config.ts for redirects |

### Alternatives Considered

| Instead of | Could Use | Tradeoff |
|------------|-----------|----------|
| Deleting orphaned routes | `next.config.ts` redirects | Redirects are safer if external bookmarks exist; deletion is cleaner. Recommend deletion since routes were never public-facing and no external links exist. |

**Installation:**
```bash
# No new dependencies needed
```

## Architecture Patterns

### Pattern 1: Async Error Handling in DnD Callbacks

**What:** Making `onDragEnd` callbacks handle async server actions with error surfacing.
**When to use:** When a drag-and-drop reorder triggers a server-side persistence action.
**Example:**
```typescript
// Source: Verified pattern from project codebase
<DragDropProvider
  onDragEnd={() => {
    // Make the callback body async via an IIFE or separate async function
    const orderedIds = stations.map((s) => s.id)
    reorderStations(meeting.id, orderedIds)
      .then((result) => {
        if (result.error) {
          setError(result.error)
        }
      })
      .catch(() => {
        setError('Kunne ikke endre rekkefolgen')
      })
  }}
>
```

**Why not `async/await` directly:** The `onDragEnd` callback type is `(event) => void`, not `(event) => Promise<void>`. Using `.then()/.catch()` avoids type conflicts while still handling errors.

### Pattern 2: Route Cleanup via File Deletion

**What:** Removing orphaned Next.js route files when the functionality has been moved elsewhere.
**When to use:** When pages have been superseded by new pages and are no longer linked.
**Example:**
```
Delete:
  src/app/admin/groups/page.tsx
  src/app/admin/wordcloud/page.tsx
```

The admin layout guard (`src/app/admin/layout.tsx`) protects all `/admin/*` routes, so these pages are not a security risk -- they are a UX dead-end where the admin sees unscoped data.

### Anti-Patterns to Avoid

- **Fixing working code:** The `.eq()` calls in `createGroup` and `toggleGroupsLock` are correct. Do NOT change `query.eq(...)` to `query = query.eq(...)` -- both forms are identical because `.eq()` mutates and returns `this`. Adding unnecessary changes introduces risk.
- **Silently swallowing async errors:** The current `reorderStations` call is fire-and-forget. Server errors are invisible to the user.

## Don't Hand-Roll

| Problem | Don't Build | Use Instead | Why |
|---------|-------------|-------------|-----|
| Async error handling in event callbacks | Custom try-catch wrapper utilities | `.then()/.catch()` on the returned promise | Simple, no abstraction needed for a single call site |
| Route redirects | Custom middleware redirect logic | Delete the files (or `next.config.ts` redirects if needed) | Next.js handles 404 automatically for deleted routes |

**Key insight:** This phase is a small bug fix + housekeeping. Avoid over-engineering.

## Common Pitfalls

### Pitfall 1: Misunderstanding Supabase Query Builder Mutability

**What goes wrong:** Developers assume Supabase's query builder is immutable (like many JavaScript fluent APIs) and conclude that calling `.eq()` without reassignment discards the filter.
**Why it happens:** Many builder patterns (e.g., Knex.js, Prisma) return new objects. The Supabase `PostgrestFilterBuilder` does NOT -- it mutates `this.url.searchParams` in place and returns `this`.
**How to avoid:** Read the source. `PostgrestFilterBuilder.eq()` at line 115 of `postgrest-js/src/PostgrestFilterBuilder.ts`: `this.url.searchParams.append(column, \`eq.${value}\`); return this`.
**Warning signs:** Any audit or review that claims `.eq()` return values must be captured -- verify against the actual library source.
**Confidence:** HIGH -- verified by reading `@supabase/postgrest-js` source code and running a direct Node.js test.

### Pitfall 2: Async Server Actions in Synchronous Callbacks

**What goes wrong:** Server action returns a Promise, but the callback doesn't handle it. Errors are silently swallowed, and the UI shows success when the server may have failed.
**Why it happens:** DnD libraries use synchronous callback types (`() => void`). Developers call the server action but forget the result is a Promise.
**How to avoid:** Always chain `.then()/.catch()` or wrap in an async IIFE when calling server actions from synchronous callbacks.
**Warning signs:** Calling an `async` function without `await` or `.then()`.

### Pitfall 3: Stale Closure Over React State in DnD Callbacks

**What goes wrong:** The `onDragEnd` callback captures `stations` from the render closure, but `onDragOver` has already updated state. The `stations` used in `onDragEnd` may be stale.
**Why it happens:** React state updates in `onDragOver` don't synchronously update the `stations` variable captured by `onDragEnd`.
**How to avoid:** In the current code, `stations` on line 333 reads the state at render time. Since `onDragOver` uses `setStations` which updates state, and `onDragEnd` fires after `onDragOver` completes and a re-render happens, the closure should have the latest state. However, this depends on render timing. A safer approach is to use a ref for the latest stations array, or compute the ordered IDs from the state setter callback.
**Warning signs:** Drag-and-drop reorder sending the wrong order to the server intermittently.
**Confidence:** MEDIUM -- depends on React render timing with `@dnd-kit/react`.

## Code Examples

### Fix 1: Await reorderStations in onDragEnd (StationList.tsx)

```typescript
// Source: Project codebase analysis
// File: src/components/admin/StationList.tsx, line ~331

// BEFORE (current — silent failure):
onDragEnd={() => {
  const orderedIds = stations.map((s) => s.id)
  reorderStations(meeting.id, orderedIds)
}}

// AFTER (error surfaced):
onDragEnd={() => {
  const orderedIds = stations.map((s) => s.id)
  reorderStations(meeting.id, orderedIds)
    .then((result) => {
      if (result.error) {
        setError(result.error)
      }
    })
    .catch(() => {
      setError('Kunne ikke endre rekkefølgen')
    })
}}
```

### Fix 2: Delete Orphaned Routes

```
Delete these files:
  src/app/admin/groups/page.tsx
  src/app/admin/wordcloud/page.tsx
```

The `revalidatePath` calls in `admin.ts` that reference `/admin/groups` should also be cleaned up. Currently four places in `admin.ts` have the pattern:
```typescript
revalidatePath(meetingId ? `/admin/meetings/${meetingId}` : '/admin/groups')
```
Since `meetingId` is always provided when called from the meeting context (and the old groups page is being deleted), the fallback to `/admin/groups` is dead code. However, the `meetingId` parameter is optional for backward compatibility, so the fallback should remain as a defensive path (or be changed to `/admin/meetings`).

### Fix 3: Consistent Client Usage (Optional Tech Debt)

```typescript
// File: src/app/admin/meetings/page.tsx
// Currently uses createClient() (RLS-scoped)
// meetings/[id]/page.tsx uses createAdminClient() (service role, bypasses RLS)
// Both work because SELECT on meetings is allowed by RLS for authenticated users.
// Recommendation: Leave as-is. The inconsistency is harmless.
```

## State of the Art

| Old Approach | Current Approach | When Changed | Impact |
|--------------|------------------|--------------|--------|
| Global groups page at `/admin/groups` | Per-meeting groups in meeting detail tabs | Phase 7 (2026-02-26) | Old route is dead-end, should be removed |
| Global word cloud at `/admin/wordcloud` | Per-meeting word cloud in meeting Resultat tab | Phase 7 (2026-02-26) | Old route shows unscoped data, should be removed |

**Deprecated/outdated:**
- `/admin/groups` page: Superseded by meeting detail Grupper tab. Shows all groups across all meetings (confusing).
- `/admin/wordcloud` page: Superseded by meeting detail Resultat tab. Shows all messages across all meetings (confusing).

## Open Questions

1. **Stale closure risk in onDragEnd**
   - What we know: `onDragEnd` captures `stations` from the render closure. `onDragOver` calls `setStations` to update state.
   - What's unclear: Whether React guarantees a re-render (and fresh closure) between `onDragOver` and `onDragEnd` in `@dnd-kit/react`. In practice it likely works because DnD events trigger re-renders.
   - Recommendation: Test manually after the fix. If intermittent wrong-order issues appear, switch to a ref-based approach. LOW priority concern.

2. **Should the old groups/wordcloud routes redirect or 404?**
   - What we know: No external links exist to these routes. They were only linked from the admin hub, which was updated in Phase 7.
   - What's unclear: Whether the admin has bookmarked these URLs.
   - Recommendation: Delete the files (resulting in 404). If the admin reports issues, add `next.config.ts` redirects later. Simplest approach wins.

## Sources

### Primary (HIGH confidence)
- `node_modules/@supabase/postgrest-js/src/PostgrestFilterBuilder.ts` lines 104-117: `.eq()` implementation confirms mutation of `this.url.searchParams` and `return this`
- `node_modules/@supabase/postgrest-js/src/PostgrestQueryBuilder.ts` lines 452-484: `.update()` creates new `PostgrestFilterBuilder` via `cloneRequestState()`
- Direct Node.js test of `PostgrestFilterBuilder.eq()` behavior: confirmed same object, URL mutated in place
- Project source: `src/lib/actions/admin.ts`, `src/components/admin/StationList.tsx`, `src/app/admin/groups/page.tsx`, `src/app/admin/wordcloud/page.tsx`

### Secondary (MEDIUM confidence)
- Context7 `/supabase/supabase-js` documentation: Confirms chaining pattern but does not explicitly document mutability
- `@dnd-kit/react` type definitions: `onDragEnd` callback type is `(event) => void`

### Tertiary (LOW confidence)
- Stale closure risk assessment: Based on React rendering model understanding, not verified with `@dnd-kit/react` specifically

## Metadata

**Confidence breakdown:**
- Standard stack: HIGH - no new dependencies, all existing
- Architecture: HIGH - small fixes with clear patterns
- Pitfalls: HIGH - verified Supabase builder behavior with source code and runtime test
- False positive identification: HIGH - definitive proof that `.eq()` mutates in place

**Research date:** 2026-02-26
**Valid until:** 2026-03-26 (stable domain, no moving targets)
