---
phase: 09-meeting-history
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/station/ChatRoom.tsx
  - src/components/dashboard/PreviousMeetingsList.tsx
  - src/components/dashboard/MeetingStationPicker.tsx
  - src/app/dashboard/meeting/[id]/page.tsx
autonomous: true
requirements: [DASH-03, DASH-04]

must_haves:
  truths:
    - "User can tap a previous meeting on the dashboard and navigate to its history page"
    - "User can select a station and group to view past discussions in read-only mode"
    - "Read-only ChatRoom displays messages without input, timer, or reopen button"
    - "User sees a clear message when a group did not discuss a particular station"
    - "Admin meeting detail view already consolidates stations, groups, export, and word cloud per meeting (DASH-04 -- pre-existing)"
  artifacts:
    - path: "src/app/dashboard/meeting/[id]/page.tsx"
      provides: "Participant-facing meeting history page with station/group picker and inline read-only ChatRoom"
      min_lines: 80
    - path: "src/components/dashboard/MeetingStationPicker.tsx"
      provides: "Client component for selecting station and group to view past discussions"
      min_lines: 40
    - path: "src/components/dashboard/PreviousMeetingsList.tsx"
      provides: "Tappable links to meeting history pages"
      contains: "Link"
    - path: "src/components/station/ChatRoom.tsx"
      provides: "hideReopen prop to suppress reopen button for completed meeting history"
      contains: "hideReopen"
  key_links:
    - from: "src/components/dashboard/PreviousMeetingsList.tsx"
      to: "/dashboard/meeting/[id]"
      via: "Next.js Link component"
      pattern: "Link.*href.*dashboard/meeting"
    - from: "src/app/dashboard/meeting/[id]/page.tsx"
      to: "src/components/dashboard/MeetingStationPicker.tsx"
      via: "Component import and render"
      pattern: "MeetingStationPicker"
    - from: "src/app/dashboard/meeting/[id]/page.tsx"
      to: "src/components/station/ChatRoom.tsx"
      via: "Inline render with readOnly={true} and hideReopen={true}"
      pattern: "ChatRoom.*readOnly.*hideReopen"
    - from: "src/app/dashboard/meeting/[id]/page.tsx"
      to: "createAdminClient"
      via: "Server-side data fetching bypassing RLS for cross-group message access"
      pattern: "createAdminClient"
---

<objective>
Create the participant-facing meeting history browsing experience. Users can tap a previous meeting on the dashboard, browse stations by group, and view past discussions in read-only mode using the existing ChatRoom component.

Purpose: Fulfills DASH-03 (read-only past discussions) and verifies DASH-04 (admin consolidated view -- already complete from Phase 7). This is primarily a "wiring" phase connecting existing components (ChatRoom readOnly, MessageList, MessageBubble) in a new context.

Output: `/dashboard/meeting/[id]` route, MeetingStationPicker component, tappable PreviousMeetingsList, ChatRoom with hideReopen prop
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-meeting-history/09-RESEARCH.md

@src/components/station/ChatRoom.tsx
@src/components/dashboard/PreviousMeetingsList.tsx
@src/app/dashboard/page.tsx
@src/app/dashboard/station/[sessionId]/page.tsx
@src/lib/actions/station.ts
@src/components/station/StationHeader.tsx
@src/app/admin/meetings/[id]/page.tsx

<interfaces>
<!-- Key types and contracts the executor needs. -->

From src/lib/hooks/useRealtimeChat.ts:
```typescript
export interface ChatMessage {
  id: string
  userId: string
  fullName: string
  role: 'youth' | 'parent'
  content: string
  createdAt: string
  status: 'pending' | 'sent'
}
```

From src/components/station/ChatRoom.tsx:
```typescript
interface ChatRoomProps {
  sessionId: string
  userId: string
  userFullName: string
  userRole: 'youth' | 'parent'
  endTimestamp: string | null
  stationTitle: string
  stationNumber: number
  stationQuestions: string[] | null
  stationTip: string | null
  initialMessages: ChatMessage[]
  readOnly?: boolean
  isStarted?: boolean
  stationId?: string
}
```

From src/lib/supabase/admin.ts:
```typescript
export function createAdminClient(): SupabaseClient
```

From src/lib/supabase/server.ts:
```typescript
export async function createClient(): Promise<SupabaseClient>
```

From src/components/dashboard/PreviousMeetingsList.tsx:
```typescript
interface PreviousMeetingsListProps {
  meetings: Array<{ id: string; title: string; date: string; venue: string | null }>
}
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add hideReopen prop to ChatRoom and convert PreviousMeetingsList to tappable links</name>
  <files>
    src/components/station/ChatRoom.tsx
    src/components/dashboard/PreviousMeetingsList.tsx
  </files>
  <action>
**ChatRoom.tsx -- add hideReopen prop:**

1. Add `hideReopen?: boolean` to the `ChatRoomProps` interface
2. Destructure `hideReopen = false` in the component function parameters
3. In the readOnly footer section (the `{localReadOnly ? (` block around line 263), wrap the "Gjen√•pne" button in a `{!hideReopen && (...)}` conditional so it is hidden when hideReopen is true
4. Do NOT change any other ChatRoom behavior -- readOnly mode, message display, header, etc. all stay the same

**PreviousMeetingsList.tsx -- convert to tappable links:**

1. Add `import Link from 'next/link'` at the top
2. Replace the outer `<div key={meeting.id} className="p-3 ...">` with `<Link href={`/dashboard/meeting/${meeting.id}`} key={meeting.id} className="block p-3 rounded-lg border border-gray-200 bg-white hover:border-teal-primary hover:shadow-sm transition-all">`
3. Add a small hint text at the bottom of each card: `<span className="text-xs text-teal-primary mt-1 block">Se diskusjoner &rarr;</span>`
4. Close with `</Link>` instead of `</div>`
  </action>
  <verify>
    <automated>cd /Users/mariusvalle-olsen/Github/TbgRuss28 && npx tsc --noEmit --pretty 2>&1 | head -30</automated>
  </verify>
  <done>ChatRoom accepts hideReopen prop and conditionally hides the reopen button. PreviousMeetingsList renders Link elements pointing to /dashboard/meeting/[id] with hover state and "Se diskusjoner" hint text.</done>
</task>

<task type="auto">
  <name>Task 2: Create MeetingStationPicker and meeting history page</name>
  <files>
    src/components/dashboard/MeetingStationPicker.tsx
    src/app/dashboard/meeting/[id]/page.tsx
  </files>
  <action>
**MeetingStationPicker.tsx -- client component for station+group selection:**

1. Create as `'use client'` component
2. Props interface:
   ```typescript
   interface MeetingStationPickerProps {
     meetingId: string
     stations: Array<{ id: string; number: number; title: string }>
     groups: Array<{ id: string; name: string }>
     selectedStation?: string
     selectedGroup?: string
   }
   ```
3. Use `useRouter` from `next/navigation` for navigation
4. Render stations as a grid of tappable cards (2 columns on mobile, matching StationCard visual style but all "completed" status). Each card shows station number and title. Selected station gets a teal border highlight (`border-teal-primary bg-teal-primary/5`)
5. When a station is tapped, navigate to `?station={stationId}` (preserving group if set) via `router.push`
6. Below the station grid, show a group selector (only visible when a station is selected). Render groups as horizontal pill buttons. Selected group gets teal background. When tapped, navigate to `?station={stationId}&group={groupId}`
7. If no station is selected, show helper text: "Velg en stasjon for a se diskusjoner"
8. If station is selected but no group, show helper text: "Velg en gruppe for a lese diskusjonen"
9. Mobile-first styling: full-width grid, min-h-[44px] touch targets, consistent with app design tokens (text-text-primary, text-text-muted, bg-warm-white, border-gray-200, teal-primary)

**Meeting history page -- /dashboard/meeting/[id]/page.tsx:**

This is a server component that fetches meeting data and renders the station/group picker and optionally the ChatRoom inline.

1. Auth check: `createClient()` -> `getUser()` -> redirect to `/login` if not authenticated
2. Fetch meeting by ID with status check -- must be `completed`. Use `supabase.from('meetings').select('id, title, date, time, venue, status').eq('id', id).eq('status', 'completed').single()`. If not found, call `notFound()`.
3. Fetch profile for current user: `supabase.from('profiles').select('full_name, role').eq('id', user.id).single()`
4. Fetch stations for this meeting: `supabase.from('stations').select('id, number, title, questions, tip').eq('meeting_id', id).order('number')`
5. Fetch groups for this meeting using admin client (RLS may restrict non-admin access): `createAdminClient().from('groups').select('id, name').eq('meeting_id', id).order('created_at')`
6. Read `searchParams` (awaited, Next.js 15 style: `const { station: stationParam, group: groupParam } = await searchParams`). The page signature uses `searchParams: Promise<{ station?: string; group?: string }>`.
7. If both `stationParam` and `groupParam` are present:
   a. Find the selected station from the fetched stations array (to get its questions/tip)
   b. Query `station_sessions` for the specific station+group combo: `admin.from('station_sessions').select('id, status').eq('station_id', stationParam).eq('group_id', groupParam).maybeSingle()`
   c. If session exists, load messages using admin client (bypasses RLS for cross-group access):
      ```typescript
      const { data: messagesData } = await admin
        .from('messages')
        .select('id, user_id, content, created_at, profiles:user_id(full_name, role)')
        .eq('session_id', session.id)
        .order('created_at', { ascending: true })
      ```
   d. Format messages into `ChatMessage[]` array with `status: 'sent'`
   e. If no session found, set a `noSession = true` flag for the "group did not discuss this station" message

8. Render the page:
   a. Back button linking to `/dashboard` with left arrow and "Tilbake" text
   b. Meeting header: title with Badge variant="completed" showing "Fullfort", date/venue info card (same style as admin meeting detail page)
   c. `<MeetingStationPicker>` component with stations, groups, selectedStation, selectedGroup props
   d. If `noSession` is true: show a card with "Denne gruppen diskuterte ikke denne stasjonen" message
   e. If session and messages loaded: render `<ChatRoom>` inline with all props:
      - `sessionId={session.id}`
      - `userId={user.id}`
      - `userFullName={profile.full_name}`
      - `userRole={profile.role as 'youth' | 'parent'}`
      - `endTimestamp={null}` (no timer for history)
      - `stationTitle`, `stationNumber`, `stationQuestions`, `stationTip` from the selected station
      - `initialMessages={formattedMessages}`
      - `readOnly={true}`
      - `isStarted={true}`
      - `hideReopen={true}` (suppress reopen button -- meeting is completed)
   f. Important: The ChatRoom renders as a full h-dvh flex column. For the history page, do NOT render the meeting header + picker AND ChatRoom at the same time in a scrollable page (ChatRoom expects to be the full viewport). Instead, when a discussion is selected, render ONLY the ChatRoom fullscreen. Modify StationHeader behavior by NOT using the ChatRoom component as-is for this case. Instead, render the messages inline WITHOUT ChatRoom's full-page layout:
      - Actually, reassessing: the cleanest approach is to render ChatRoom full-screen when a station+group is selected, but override the back button behavior. Since StationHeader always navigates to `/dashboard`, and the user should go back to the meeting history page: the simplest fix is to NOT render the full ChatRoom component. Instead, render the station context (questions/tip), MessageList, and the "Diskusjonen er avsluttet" footer INLINE in the meeting history page, below the picker.
      - Import `MessageList` from `@/components/station/MessageList` and render it directly with the formatted messages inside a scrollable container.
      - This avoids the StationHeader back-button problem entirely and gives better UX (user stays on the same page, can switch groups/stations without full navigation).
   g. The inline message display section should:
      - Show a station context card with questions/tip (same as ChatRoom's inline context card)
      - Show a group name label (e.g., "Gruppe: {groupName}")
      - Render `<MessageList messages={messages} currentUserId={user.id} />` in a scrollable container
      - Show "Diskusjonen er avsluttet" footer text (no reopen button)
      - If the session has 0 messages, show "Ingen meldinger i denne diskusjonen"

9. Use `formatDate` helper for Norwegian date formatting (same pattern as PreviousMeetingsList: `toLocaleDateString('nb-NO', { weekday: 'long', day: 'numeric', month: 'long' })`)

10. DASH-04 verification: The admin meeting detail view at `/admin/meetings/[id]` already consolidates Stasjoner (station config), Grupper (group management/viewing with readOnly for completed meetings), and Resultat (export + word cloud) in MeetingTabs. No code changes needed for DASH-04 -- it is already satisfied by the existing admin pages built in Phase 7. Note this in the plan SUMMARY.
  </action>
  <verify>
    <automated>cd /Users/mariusvalle-olsen/Github/TbgRuss28 && npx tsc --noEmit --pretty 2>&1 | head -30 && npx next build 2>&1 | tail -20</automated>
  </verify>
  <done>Meeting history page at /dashboard/meeting/[id] renders with station/group picker and inline read-only message display. Users can browse any group's discussions from completed meetings. Selecting a station then group loads messages inline with station context. "No discussion" message shows when a group did not visit a station. DASH-04 verified as already complete via existing admin /admin/meetings/[id] page.</done>
</task>

</tasks>

<verification>
1. TypeScript compilation passes with no errors: `npx tsc --noEmit`
2. Next.js build succeeds: `npx next build`
3. PreviousMeetingsList renders Link elements to /dashboard/meeting/[id]
4. /dashboard/meeting/[id] page loads for completed meetings, returns 404 for non-completed
5. Station/group picker renders all stations and groups for the meeting
6. Selecting a station+group shows messages inline or "no discussion" message
7. ChatRoom hideReopen prop hides the reopen button (verified via code inspection)
8. Admin /admin/meetings/[id] page continues to work with full MeetingTabs for all meeting statuses
</verification>

<success_criteria>
- Dashboard previous meetings are tappable links that navigate to meeting history pages
- Meeting history page shows meeting details (title, date, venue) with station/group picker
- Selecting a station and group displays the discussion messages in read-only mode
- Groups that did not visit a station show a clear "no discussion" message
- No reopen button appears when viewing completed meeting history
- Admin meeting detail view (DASH-04) remains fully functional with stations, groups, export, and word cloud tabs
- All Norwegian UI text is correct (no English strings in user-facing UI)
</success_criteria>

<output>
After completion, create `.planning/phases/09-meeting-history/09-01-SUMMARY.md`
</output>
